<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Карта монтажа — контуры домов (Leaflet/OSM)</title>

  <!-- Leaflet без ключей -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    #app { display: grid; grid-template-columns: 380px 1fr; height: 100%; }
    #sidebar { padding: 14px; border-right: 1px solid #eee; overflow: auto; }
    #map { width: 100%; height: 100%; }
    .panel { background: #fafafa; border: 1px solid #eaeaea; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .row input, .row button, textarea { font-size: 14px; }
    textarea { width: 100%; min-height: 120px; resize: vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; }
    .legend { display: grid; grid-template-columns: 1fr auto; gap: 6px 10px; font-size: 13px; }
    .swatch { width: 18px; height: 18px; border-radius: 4px; border: 1px solid rgba(0,0,0,.15); }
    .item { padding: 8px 10px; border-radius: 10px; border: 1px dashed #ddd; margin-bottom: 6px; cursor: pointer; }
    .muted { color: #666; font-size: 13px; }
    .pill { padding: 2px 6px; border-radius: 999px; font-size: 12px; background: #f1f5f9; border: 1px solid #e5e7eb; }
    .hint { font-size: 12px; color:#475569; }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="panel">
      <div style="font-weight:700;">Карта монтажа — Leaflet/OSM</div>
      <div class="muted">Загрузи CSV/TSV или вставь вручную. Цвета — по компаниям. Подписи можно включить чекбоксом.</div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Загрузка файла (CSV/TSV)</div>
      <div class="row">
        <input type="file" id="fileInput" accept=".csv,.tsv,.txt" />
        <button id="btnBuildFile">Загрузить и построить</button>
      </div>
      <div class="hint" style="margin-top:8px;">
        Колонки: <b>Город</b>, <b>Адрес</b>, <b>Компания</b>. Формат адреса: «г. Саратов, улица Рахова, 169/171».
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <div style="font-weight:600;">Адреса (ручной ввод)</div>
        <label class="row" style="gap:6px;">
          <input type="checkbox" id="chkLabels" />
          Показывать подписи на карте
        </label>
      </div>
      <textarea id="addrInput" placeholder="Форматы:
• г. Саратов, улица Рахова, 169/171[TAB]ООО Альфа
• Город, Адрес[TAB]Компания
• Старый 6-колоночный: ID ID2 Город Улица Дом Подъезд"></textarea>
      <div class="row" style="margin-top:8px;">
        <button id="btnBuild">Построить</button>
        <button id="btnClear">Очистить</button>
        <button id="btnFit">Показать все</button>
      </div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Легенда компаний</div>
      <div id="legend" class="legend"></div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Найденные точки</div>
      <div id="list"></div>
    </div>
  </div>
  <div id="map"></div>
</div>

<script>
(function(){
  // ===== Карта =====
  const map = L.map('map').setView([51.533, 46.033], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const $ = (s)=>document.querySelector(s);
  const state = {
    layers: [],                  // массив Leaflet-слоёв
    labelEntries: [],            // [{layer, label}]
    bounds: L.latLngBounds()
  };

  function clearAll(){
    state.layers.forEach(l => map.removeLayer(l));
    state.layers = [];
    state.labelEntries = [];
    state.bounds = L.latLngBounds();
    $('#list').innerHTML = '';
  }

  function addListItem(item){
    const el=document.createElement('div');
    el.className='item';
    el.innerHTML=`<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
      <div style="font-weight:600">${escapeHtml(item.address)}</div>
      ${item.company?`<span class='pill' style='border:1px solid ${item.color||'#ddd'}'>${escapeHtml(item.company)}</span>`:''}
    </div><div class='muted'>${item.lat&&item.lon?`${item.lat.toFixed(6)}, ${item.lon.toFixed(6)}`:'—'}</div>`;
    el.addEventListener('click',()=>{ if(item.lat&&item.lon){ map.setView([item.lat,item.lon], 17); } });
    $('#list').appendChild(el);
  }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // ===== Цвета по компаниям / легенда =====
  const companyColor = new Map();
  function hash(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return h; }
  function colorByCompany(company){
    if(!company) return '#7c3aed';
    if(companyColor.has(company)) return companyColor.get(company);
    const h=Math.abs(hash(company))%360;
    const c=`hsl(${h} 85% 45%)`;
    companyColor.set(company,c);
    return c;
  }
  function addLegendRow(s,c){ const host=$('#legend'); const t=document.createElement('div'); t.textContent=s||'(без компании)'; const sw=document.createElement('div'); sw.className='swatch'; sw.style.background=c||'#7c3aed'; host.appendChild(t); host.appendChild(sw); }
  function rebuildLegend(){
    const host=$('#legend'); host.innerHTML='';
    const arr=Array.from(companyColor.entries());
    if(!arr.length){ addLegendRow('Адреса','#7c3aed'); return; }
    arr.sort((a,b)=>a[0].localeCompare(b[0],'ru'));
    arr.forEach(([s,c])=>addLegendRow(s,c));
  }

  // ===== Парсеры =====
  function parseTextarea(text){
    const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const out=[];
    for(const line of lines){
      // 6 колонок: ID ID2 City Street House Entrance
      const m6=/^(\S+)\s+(\S+)\s+(\S+)\s+(.+?)\s+(\S+)\s+(\S+)$/.exec(line);
      if(m6){
        const city=m6[3], street=m6[4], house=m6[5];
        out.push({ address:`${city}, ${street} ${house}`, company:'' });
        continue;
      }
      // таб-раздел: Адрес \t Компания
      const tab=line.split(/\t/);
      if(tab.length>=2){
        const addrRaw=tab[0]?.trim();
        const company=tab[1]?.trim();
        out.push({ address:addrRaw, company });
        continue;
      }
      out.push({ address: line, company: '' });
    }
    return out;
  }

  function detectDelimiter(text){
    const firstLine = text.split(/\r?\n/).find(l=>l.trim().length>0) || '';
    const counts = {'\t': (firstLine.match(/\t/g)||[]).length,';': (firstLine.match(/;/g)||[]).length,',': (firstLine.match(/,/g)||[]).length};
    return Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0] || ',';
  }
  function parseCSV(text){
    const delim = detectDelimiter(text);
    const rows = text.split(/\r?\n/).filter(l=>l.trim().length>0);
    if(rows.length===0) return [];
    const header = rows[0].split(delim).map(s=>s.trim().toLowerCase());
    const idxCity = header.findIndex(h=>/^(город|city)$/i.test(h));
    const idxAddr = header.findIndex(h=>/^(адрес|address)$/i.test(h));
    const idxCompany = header.findIndex(h=>/^(компан|company)/i.test(h));

    const out=[];
    for(let i=1;i<rows.length;i++){
      const cols = rows[i].split(delim).map(s=>s.trim());
      const city = idxCity>=0 ? cols[idxCity] : '';
      const addr = idxAddr>=0 ? cols[idxAddr] : '';
      const comp = idxCompany>=0 ? cols[idxCompany] : '';
      const full = city ? `${city}, ${addr}` : addr;
      if (full) out.push({ address: full, company: comp });
    }
    return out;
  }

  // ===== Геокодеры =====
  async function geocodePhoton(address){
    const url = new URL('https://photon.komoot.io/api/');
    url.searchParams.set('q', address);
    url.searchParams.set('limit', '1');
    const r = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
    if(!r.ok) return null;
    const j = await r.json();
    const f = j?.features?.[0];
    if(!f) return null;
    const point = f.geometry?.type==='Point' ? f.geometry.coordinates : null; // [lon, lat]
    let polygon = null;
    if (f.geometry?.type === 'Polygon') polygon = f.geometry.coordinates[0];
    if (f.geometry?.type === 'MultiPolygon') polygon = f.geometry.coordinates[0][0];
    return { point, polygon };
  }
  async function geocodeNominatim(address){
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('q', address);
    url.searchParams.set('format', 'jsonv2');
    url.searchParams.set('limit', '1');
    const r = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
    if(!r.ok) return null;
    const arr = await r.json();
    const obj = arr?.[0];
    if(!obj) return null;
    const point = obj.lon && obj.lat ? [parseFloat(obj.lon), parseFloat(obj.lat)] : null;
    return { point, polygon: null };
  }
  async function geocode(address){
    let res = await geocodePhoton(address);
    if (res) return res;
    await new Promise(r=>setTimeout(r,150));
    return await geocodeNominatim(address);
  }

  // ===== Overpass: контур здания =====
  async function fetchBuildingPolygon({ lon, lat }) {
    const R = 200;
    const q = `
      [out:json][timeout:25];
      (
        way["building"](around:${R},${lat},${lon});
        relation["building"](around:${R},${lat},${lon});
      );
      out body geom;
    `.trim();

    const resp = await fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
      body: new URLSearchParams({ data: q })
    });
    if (!resp.ok) return null;
    const data = await resp.json();
    if (!Array.isArray(data.elements) || !data.elements.length) return null;

    function dist2(aLat, aLon, bLat, bLon) {
      const dLat = (aLat - bLat), dLon = (aLon - bLon);
      return dLat*dLat + dLon*dLon;
    }

    let best = null, bestD = Infinity;

    for (const el of data.elements) {
      if ((el.type === 'way' || el.type === 'relation') && Array.isArray(el.geometry) && el.geometry.length >= 4) {
        const ring = el.geometry.map(p => [p.lat, p.lon]);
        const first = ring[0], last = ring[ring.length - 1];
        if (first[0] !== last[0] || first[1] !== last[1]) ring.push(first);
        // центр bbox
        let minLat=+Infinity, minLon=+Infinity, maxLat=-Infinity, maxLon=-Infinity;
        for (const [la,lo] of ring) {
          if (la<minLat) minLat=la; if (la>maxLat) maxLat=la;
          if (lo<minLon) minLon=lo; if (lo>maxLon) maxLon=lo;
        }
        const cLat = (minLat+maxLat)/2, cLon = (minLon+maxLon)/2;
        const d = dist2(cLat, cLon, lat, lon);
        if (d < bestD) { bestD = d; best = ring; }
      }
    }
    return best || null;
  }

  // ===== Геометрия =====
  function squareAround([lon, lat], meters = 30){
    const dLat = (meters / 111320);
    const dLon = (meters / (40075000 * Math.cos(lat*Math.PI/180) / 360));
    return [
      [lat+dLat, lon-dLon],
      [lat+dLat, lon+dLon],
      [lat-dLat, lon+dLon],
      [lat-dLat, lon-dLon]
    ];
  }
  function withAlpha(color, a){
    if(/^#([0-9a-f]{6})$/i.test(color)){
      const r=parseInt(color.slice(1,3),16), g=parseInt(color.slice(3,5),16), b=parseInt(color.slice(5,7),16);
      return `rgba(${r},${g},${b},${a})`;
    }
    if(/^hsl\(/i.test(color)){
      return color.replace(/^hsl/i,'hsla').replace(/\)$/,`, ${a})`);
    }
    return color;
  }

  // ===== Подписи (tooltip) переключатель =====
  function applyTooltip(layer, label){
    const permanent = $('#chkLabels').checked;
    if (layer._tooltip) layer.unbindTooltip();
    layer.bindTooltip(label, {
      permanent,
      direction: 'top',
      className: 'company-tooltip',
      sticky: !permanent
    });
    if (permanent) layer.openTooltip();
  }
  function reapplyAllTooltips(){
    const permanent = $('#chkLabels').checked;
    state.labelEntries.forEach(({layer, label})=>{
      if (layer._tooltip) layer.unbindTooltip();
      layer.bindTooltip(label, {
        permanent,
        direction: 'top',
        className: 'company-tooltip',
        sticky: !permanent
      });
      if (permanent) layer.openTooltip();
    });
  }
  $('#chkLabels').addEventListener('change', reapplyAllTooltips);

  // ===== Popup (карточка адреса) =====
  function popupHtml({company, address, color, lat, lon}){
    const coord = (lat&&lon) ? `<div class='muted' style="margin-top:6px">${lat.toFixed(6)}, ${lon.toFixed(6)}</div>` : '';
    return `
      <div style="font-weight:700; margin-bottom:4px;">
        <span class="pill" style="border:1px solid ${color};">${escapeHtml(company||'(без компании)')}</span>
      </div>
      <div>${escapeHtml(address)}</div>
      ${coord}
    `;
  }

  // ===== Построение =====
  async function buildFromItems(items){
    clearAll();
    for(const item of items){
      const color = colorByCompany(item.company||'');
      try{
        const res = await geocode(item.address);
        if(!res){
          addListItem({...item, color});
          continue;
        }
        let latlng = null;

        if(res.polygon){
          const ringLatLng = res.polygon.map(([lon,lat])=>[lat,lon]);
          const poly = L.polygon(ringLatLng, { color: color, weight: 2, fillColor: withAlpha(color,0.35) }).addTo(map);
          state.layers.push(poly);
          latlng = poly.getBounds().getCenter();
          // подпись и попап
          const label = item.company || '';
          applyTooltip(poly, label);
          poly.bindPopup(popupHtml({company:item.company,address:item.address,color,lat:latlng.lat||latlng[0],lon:latlng.lng||latlng[1]}));
          state.labelEntries.push({layer: poly, label});

        } else if(res.point){
          const [lon, lat] = res.point;
          let ring = null;
          try { ring = await fetchBuildingPolygon({ lon, lat }); } catch(e){ console.warn('Overpass fail', e); }

          if (ring && ring.length >= 4) {
            const poly = L.polygon(ring, { color: color, weight: 2, fillColor: withAlpha(color,0.35) }).addTo(map);
            state.layers.push(poly);
            latlng = poly.getBounds().getCenter();
            const label = item.company || '';
            applyTooltip(poly, label);
            poly.bindPopup(popupHtml({company:item.company,address:item.address,color,lat:latlng.lat||latlng[0],lon:latlng.lng||latlng[1]}));
            state.labelEntries.push({layer: poly, label});
          } else {
            const sq = squareAround([lon,lat], 30).map(([la,lo])=>[la,lo]);
            const poly = L.polygon(sq, { color: color, weight: 2, fillColor: withAlpha(color,0.35) }).addTo(map);
            const dot  = L.circleMarker([lat,lon], { radius: 4, color: '#fff', weight: 2, fillColor: color, fillOpacity: 1 }).addTo(map);
            state.layers.push(poly, dot);
            latlng = [lat,lon];
            const label = item.company || '';
            applyTooltip(poly, label);
            poly.bindPopup(popupHtml({company:item.company,address:item.address,color,lat:latlng[0],lon:latlng[1]}));
            state.labelEntries.push({layer: poly, label});
          }
        }

        if(latlng){
          item.lat = latlng.lat!==undefined ? latlng.lat : latlng[0];
          item.lon = latlng.lng!==undefined ? latlng.lng : latlng[1];
          state.bounds.extend([item.lat, item.lon]);
        }
        addListItem({...item, color});
        await new Promise(r=>setTimeout(r,160));
      }catch(e){
        console.warn('Ошибка геокодинга', item.address, e);
        addListItem({...item, color});
      }
    }
    rebuildLegend();
    if(state.bounds.isValid()) map.fitBounds(state.bounds.pad(0.2));
  }

  // ===== Обработчики =====
  document.getElementById('btnBuild').addEventListener('click', ()=>{
    const items = parseTextarea(document.getElementById('addrInput').value);
    buildFromItems(items);
  });
  document.getElementById('btnBuildFile').addEventListener('click', async ()=>{
    const f = document.getElementById('fileInput').files?.[0];
    if(!f){ alert('Выбери файл CSV/TSV'); return; }
    const text = await f.text();
    const items = parseCSV(text);
    if(items.length===0){ alert('Не удалось прочитать данные. Проверь колонки: Город, Адрес, Компания.'); return; }
    buildFromItems(items);
  });
  document.getElementById('btnClear').addEventListener('click', ()=>{
    document.getElementById('addrInput').value='';
    clearAll(); companyColor.clear(); rebuildLegend();
  });
  document.getElementById('btnFit').addEventListener('click', ()=>{
    if(state.bounds.isValid()) map.fitBounds(state.bounds.pad(0.2));
  });

  // демо-вставка
  document.getElementById('addrInput').value = [
    'г. Саратов, улица 1-я Беговая, 13\tООО Бета',
    'г. Саратов, улица 1-й Кавказский, 10\tООО Бета',
    'г. Саратов, улица Рахова, 169/171\tООО Альфа'
  ].join('\n');
})();
</script>
</body>
</html>
