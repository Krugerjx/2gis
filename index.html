<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Карта монтажа — контуры домов (Leaflet/OSM)</title>

  <!-- Leaflet без ключей -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    #app { display: grid; grid-template-columns: 400px 1fr; height: 100%; }
    #sidebar { padding: 14px; border-right: 1px solid #eee; overflow: auto; }
    #map { width: 100%; height: 100%; }
    .panel { background: #fafafa; border: 1px solid #eaeaea; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .row input, .row button, textarea { font-size: 14px; }
    textarea { width: 100%; min-height: 120px; resize: vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; }
    .legend { display: grid; grid-template-columns: 1fr auto; gap: 6px 10px; font-size: 13px; }
    .swatch { width: 18px; height: 18px; border-radius: 4px; border: 1px solid rgba(0,0,0,.15); cursor: pointer; }
    .item { padding: 8px 10px; border-radius: 10px; border: 1px dashed #ddd; margin-bottom: 6px; cursor: pointer; }
    .muted { color: #666; font-size: 13px; }
    .pill { padding: 2px 6px; border-radius: 999px; font-size: 12px; background: #f1f5f9; border: 1px solid #e5e7eb; }
    .hint { font-size: 12px; color:#475569; }

    /* Палитра выбора цвета */
    .color-picker {
      position: absolute;
      display: none;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 8px;
      box-shadow: 0 10px 24px rgba(0,0,0,.15);
      z-index: 9999;
      grid-template-columns: repeat(10, 22px);
      gap: 6px;
    }
    .color-cell {
      width: 22px; height: 22px;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,.2);
      cursor: pointer;
    }

    /* Номера домов — компактные, «прижаты» к контуру */
    .house-label {
      background: transparent;
      border: none;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    .house-label .hl {
      display: inline-block;
      padding: 0 3px;
      font-size: 9px;
      font-weight: 700;
      background: rgba(255,255,255,.96);
      border: 2px solid var(--hl-color, rgba(0,0,0,.25));
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,.10);
      line-height: 1.1;
      white-space: nowrap;
      user-select: none;
    }

    .tip { font-size: 12px; color:#64748b; }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="panel">
      <div style="font-weight:700;">Карта монтажа — Leaflet/OSM</div>
      <div class="muted">Загрузи CSV/TSV или вставь вручную. Цвета — по компаниям. Подписи/номера — чекбоксами.</div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Загрузка файла (CSV/TSV)</div>
      <div class="row">
        <input type="file" id="fileInput" accept=".csv,.tsv,.txt" />
        <button id="btnBuildFile">Загрузить и построить</button>
      </div>
      <div class="hint" style="margin-top:8px;">
        Колонки: <b>Город</b>, <b>Адрес</b>, <b>Компания</b>. Если разделитель — запятая, адреса с запятыми оборачивай в кавычки.
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <div style="font-weight:600;">Адреса (ручной ввод)</div>
        <div class="row" style="gap:12px;">
          <label class="row" style="gap:6px;">
            <input type="checkbox" id="chkLabels" />
            Подписи компаний
          </label>
          <label class="row" style="gap:6px;">
            <input type="checkbox" id="chkHnums" />
            Номера домов
          </label>
        </div>
      </div>
      <textarea id="addrInput" placeholder="Форматы:
• г. Саратов, улица Рахова, 169/171[TAB]ООО Альфа
• г. Саратов, улица Рахова, 169/171 ↵
  ООО Альфа (на следующей строке)
• Город, Адрес[TAB]Компания
• Старый 6-колоночный: ID ID2 Город Улица Дом Подъезд"></textarea>
      <div class="row" style="margin-top:8px;">
        <button id="btnBuild">Построить</button>
        <button id="btnClear">Очистить</button>
        <button id="btnFit">Показать все</button>
      </div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Выбор домов</div>
      <label class="row" style="gap:6px; margin-bottom:6px;">
        <input type="checkbox" id="chkSelectMode" />
        Режим выбора домов
      </label>
      <label class="row" style="gap:6px; margin-bottom:6px;">
        <input type="checkbox" id="chkOnlySel" />
        Показывать на карте только выбранные
      </label>
      <div class="row" style="margin-bottom:8px;">
        <button id="btnSelectBox">Выделить прямоугольником</button>
        <button id="btnClearSel">Сбросить выделение</button>
      </div>
      <div class="row">
        <button id="btnGenerate">Сгенерировать наряд (таблица)</button>
        <button id="btnExportMap">Экспорт карты (только выбранные)</button>
      </div>
      <div class="tip" style="margin-top:6px;">В режиме выбора кликай по дому для (де)выделения. Shift+перетаскивание — выделение прямоугольником.</div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Легенда компаний</div>
      <div id="legend" class="legend"></div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Найденные точки</div>
      <div id="list"></div>
    </div>
  </div>
  <div id="map"></div>
</div>

<!-- Палитра (портал) -->
<div id="colorPicker" class="color-picker" role="dialog" aria-hidden="true"></div>

<script>
(function(){
  // ===== Карта =====
  const map = L.map('map').setView([51.533, 46.033], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

  const $ = (s)=>document.querySelector(s);
  const state = {
    layers: [],         // полигоны/квадраты домов
    labelEntries: [],   // тултипы компаний
    numberMarkers: [],  // метки номеров
    items: [],          // список для сайдбара
    bounds: L.latLngBounds(),
    selected: new Set(),
    hidden: new Set(),  // скрытые (для "только выбранные")
  };

  // ===== Утилиты =====
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function addListItem(item){
    const el=document.createElement('div');
    el.className='item';
    el.innerHTML=`<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
      <div style="font-weight:600">${escapeHtml(item.address)}</div>
      ${item.company?`<span class='pill' style='border:1px solid ${item.color||'#ddd'}'>${escapeHtml(item.company)}</span>`:''}
    </div><div class='muted'>${item.lat!=null&&item.lon!=null?`${Number(item.lat).toFixed(6)}, ${Number(item.lon).toFixed(6)}`:'—'}</div>`;
    el.addEventListener('click',()=>{ if(item.lat!=null&&item.lon!=null){ map.setView([item.lat,item.lon], 17); } });
    $('#list').appendChild(el);
  }
  function rerenderList(){
    $('#list').innerHTML='';
    for(const it of state.items){
      const color = colorByCompany(it.company||'');
      addListItem({...it, color});
    }
  }
  function clearAll(){
    state.layers.forEach(l => map.removeLayer(l));
    state.numberMarkers.forEach(m => map.removeLayer(m));
    state.labelEntries = [];
    state.numberMarkers = [];
    state.layers = [];
    state.items = [];
    state.bounds = L.latLngBounds();
    state.selected.clear();
    state.hidden.clear();
    $('#list').innerHTML = '';
  }

  // ===== Цвета / легенда =====
  const companyColor = new Map();
  const CONTRAST_COLORS = [
    '#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4',
    '#46f0f0','#f032e6','#bcf60c','#fabebe','#008080','#e6beff',
    '#9a6324','#fffac8','#800000','#aaffc3','#808000','#ffd8b1',
    '#000075','#808080','#7f7f7f','#42d4f4','#bfef45','#ffd700',
    '#0082c8','#aa6e28','#d2f53c','#d66dd6','#00a2e8','#ffaec9',
    '#a10000','#00a100','#0044a1','#7f007f','#00a199','#ff7f00'
  ];
  function hash(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return h; }
  function colorByCompany(company){
    if(!company) return '#7c3aed';
    if(companyColor.has(company)) return companyColor.get(company);
    const idx = Math.abs(hash(company)) % CONTRAST_COLORS.length;
    const c = CONTRAST_COLORS[idx];
    companyColor.set(company,c);
    return c;
  }
  function setCompanyColor(company, color){
    companyColor.set(company, color);
    recolorLayers(company, color);
    rebuildLegend();
    rerenderList();
    rebuildHouseLabels();
  }
  function recolorLayers(company, color){
    for(const layer of state.layers){
      if(layer && layer._company === company && typeof layer.setStyle === 'function'){
        layer.setStyle({ color, fillColor: color });
      }
    }
  }
  function addLegendRow(s,c){
    const host=$('#legend');
    const t=document.createElement('div'); t.textContent=s||'(без компании)';
    const sw=document.createElement('div');
    sw.className='swatch swatch-click';
    sw.style.background=c||'#7c3aed';
    if (s) {
      sw.title = 'Изменить цвет';
      sw.addEventListener('click', (ev)=> openColorPickerFor(s, ev.currentTarget));
    }
    host.appendChild(t); host.appendChild(sw);
  }
  function rebuildLegend(){
    const host=$('#legend'); host.innerHTML='';
    const arr=Array.from(companyColor.entries());
    if(!arr.length){ addLegendRow('Адреса','#7c3aed'); return; }
    arr.sort((a,b)=>a[0].localeCompare(b[0],'ru'));
    arr.forEach(([s,c])=>addLegendRow(s,c));
  }

  // ===== Палитра выбора цвета =====
  const pickerEl = document.getElementById('colorPicker');
  let pickerCompany = null;
  (function fillPalette(){
    pickerEl.style.display='grid';
    pickerEl.innerHTML='';
    CONTRAST_COLORS.forEach(col=>{
      const cell=document.createElement('div');
      cell.className='color-cell';
      cell.style.background=col;
      cell.addEventListener('click', ()=>{ if(pickerCompany){ setCompanyColor(pickerCompany, col); hidePicker(); }});
      pickerEl.appendChild(cell);
    });
    pickerEl.style.display='none';
  })();
  function openColorPickerFor(company, anchor){
    pickerCompany = company;
    const r = anchor.getBoundingClientRect();
    pickerEl.style.left = Math.min(window.scrollX + r.left, window.scrollX + window.innerWidth - 250) + 'px';
    pickerEl.style.top  = (window.scrollY + r.bottom + 8) + 'px';
    pickerEl.style.display = 'grid';
    pickerEl.setAttribute('aria-hidden','false');
  }
  function hidePicker(){
    pickerEl.style.display='none';
    pickerEl.setAttribute('aria-hidden','true');
    pickerCompany = null;
  }
  document.addEventListener('click',(e)=>{
    if(pickerEl.style.display==='none') return;
    const withinPicker = pickerEl.contains(e.target);
    const onSwatch = e.target.classList && e.target.classList.contains('swatch-click');
    if(!withinPicker && !onSwatch) hidePicker();
  });

  // ===== Парсеры =====
  function isCompanyLine(s){
    const t = String(s||'').trim();
    return /^((ООО|ОАО|ПАО|ЗАО|АО|ИП|ТОО|OOO|LLC|LTD|GMBH|GmbH)|[0OО]{3})\b/i.test(t);
  }
  function normalizeCompany(s){
    return String(s||'').trim()
      .replace(/^[0OО]{3}\b\.?/i,'ООО')
      .replace(/\s+/g,' ')
      .trim();
  }
  function parseTextarea(text){
    const raw = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const out=[];
    for(let i=0;i<raw.length;i++){
      let line = raw[i];
      const parts = line.split(/\t/);
      if (parts.length >= 2){
        out.push({ address: parts[0].trim(), company: normalizeCompany(parts.slice(1).join(' ').trim()) });
        continue;
      }
      let m = line.match(/^(.*?)(?:\s{2,}|[—\-:;|]\s*)(\b(?:ООО|ОАО|ПАО|ЗАО|АО|ИП|OOO|LLC|LTD|GMBH|[0OО]{3})\b\.?\s*.*)$/i);
      if(m){ out.push({ address: m[1].trim(), company: normalizeCompany(m[2]) }); continue; }
      if(i+1 < raw.length && isCompanyLine(raw[i+1])){ out.push({ address: line, company: normalizeCompany(raw[i+1]) }); i++; continue; }
      out.push({ address: line, company: '' });
    }
    return out;
  }
  function stripBOM(s){ return s.replace(/^\uFEFF/, ''); }
  function smartSplit(line, delim){
    const out=[], d = delim, n = line.length;
    let cur='', inQ=false;
    for(let i=0;i<n;i++){
      const ch=line[i];
      if(ch === '"'){ if(inQ && line[i+1] === '"'){ cur+='"'; i++; } else inQ=!inQ; }
      else if(!inQ && ch === d){ out.push(cur); cur=''; }
      else { cur+=ch; }
    }
    out.push(cur);
    return out.map(s=>s.trim());
  }
  function detectDelimiter(text){
    const sample = stripBOM(text).split(/\r?\n/).filter(l=>l.trim()).slice(0,6);
    const cands=[',',';','\t'];
    function score(d){
      const cols = sample.map(l=>smartSplit(l,d).length);
      const min=Math.min(...cols), max=Math.max(...cols);
      return {d, spread:max-min, maxCols:Math.max(...cols)};
    }
    return cands.map(score).sort((a,b)=> a.spread-b.spread || b.maxCols-a.maxCols)[0].d;
  }
  function parseCSV(text){
    const t = stripBOM(text);
    const delim = detectDelimiter(t);
    const rows = t.split(/\r?\n/).filter(l=>l.trim().length>0);
    if(rows.length===0) return [];
    const header = smartSplit(rows[0], delim).map(h=>h.replace(/^"|"$/g,'').trim().toLowerCase());
    const idxCity    = header.findIndex(h=>/^(город|city)$/.test(h));
    const idxAddr    = header.findIndex(h=>/^(адрес|address)$/.test(h));
    const idxCompany = header.findIndex(h=>/^(компан|company)/.test(h));
    const out=[];
    for(let i=1;i<rows.length;i++){
      const cols = smartSplit(rows[i], delim).map(v=>{
        if(v.startsWith('"') && v.endsWith('"')) v=v.slice(1,-1).replace(/""/g,'"');
        return v.trim();
      });
      const city = idxCity>=0 ? cols[idxCity] : '';
      const addr = idxAddr>=0 ? cols[idxAddr] : '';
      const comp = idxCompany>=0 ? cols[idxCompany] : '';
      const full = city ? `${city}, ${addr}` : addr;
      if(full) out.push({ address: full, company: normalizeCompany(comp) });
    }
    return out;
  }

  // ===== Геокодеры =====
  async function geocodePhoton(address){
    const url = new URL('https://photon.komoot.io/api/'); url.searchParams.set('q', address); url.searchParams.set('limit', '1');
    const r = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
    if(!r.ok) return null;
    const j = await r.json();
    const f = j?.features?.[0];
    if(!f) return null;
    const point = f.geometry?.type==='Point' ? f.geometry.coordinates : null; // [lon, lat]
    let polygon = null;
    if (f.geometry?.type === 'Polygon') polygon = f.geometry.coordinates[0];
    if (f.geometry?.type === 'MultiPolygon') polygon = f.geometry.coordinates[0][0];
    return { point, polygon };
  }
  async function geocodeNominatim(address){
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('q', address); url.searchParams.set('format', 'jsonv2'); url.searchParams.set('limit', '1');
    const r = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
    if(!r.ok) return null;
    const arr = await r.json();
    const obj = arr?.[0];
    if(!obj) return null;
    const point = obj.lon && obj.lat ? [parseFloat(obj.lon), parseFloat(obj.lat)] : null;
    return { point, polygon: null };
  }
  async function geocode(address){
    let res = await geocodePhoton(address);
    if (res) return res;
    await new Promise(r=>setTimeout(r,150));
    return await geocodeNominatim(address);
  }

  // ===== Overpass: контур здания =====
  async function fetchBuildingPolygon({ lon, lat }) {
    const R = 200;
    const q = `
      [out:json][timeout:25];
      (
        way["building"](around:${R},${lat},${lon});
        relation["building"](around:${R},${lat},${lon});
      );
      out body geom;
    `.trim();

    const resp = await fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
      body: new URLSearchParams({ data: q })
    });
    if (!resp.ok) return null;
    const data = await resp.json();
    if (!Array.isArray(data.elements) || !data.elements.length) return null;

    function dist2(aLat, aLon, bLat, bLon) { const dLat = (aLat - bLat), dLon = (aLon - bLon); return dLat*dLat + dLon*dLon; }
    let best = null, bestD = Infinity;
    for (const el of data.elements) {
      if ((el.type === 'way' || el.type === 'relation') && Array.isArray(el.geometry) && el.geometry.length >= 4) {
        const ring = el.geometry.map(p => [p.lat, p.lon]);
        const first = ring[0], last = ring[ring.length - 1];
        if (first[0] !== last[0] || first[1] !== last[1]) ring.push(first);
        let minLat=+Infinity, minLon=+Infinity, maxLat=-Infinity, maxLon=-Infinity;
        for (const [la,lo] of ring) { if (la<minLat) minLat=la; if (la>maxLat) maxLat=la; if (lo<minLon) minLon=lo; if (lo>maxLon) maxLon=lo; }
        const cLat=(minLat+maxLat)/2, cLon=(minLon+maxLon)/2;
        const d = dist2(cLat, cLon, lat, lon);
        if (d < bestD) { bestD = d; best = ring; }
      }
    }
    return best || null;
  }

  // ===== Подписи компаний =====
  function applyTooltip(layer, label){
    const permanent = $('#chkLabels').checked;
    if (layer._tooltip) layer.unbindTooltip();
    layer.bindTooltip(label, { permanent, direction: 'top', className: 'company-tooltip', sticky: !permanent });
    if (permanent) layer.openTooltip();
  }
  function reapplyAllTooltips(){
    const permanent = $('#chkLabels').checked;
    state.labelEntries.forEach(({layer, label})=>{
      if (layer._tooltip) layer.unbindTooltip();
      layer.bindTooltip(label, { permanent, direction: 'top', className: 'company-tooltip', sticky: !permanent });
      if (permanent) layer.openTooltip();
    });
  }
  $('#chkLabels').addEventListener('change', reapplyAllTooltips);

  // ===== Номера домов: «прижать» к контуру =====
  function extractHouse(address){
    const s = String(address||'').replace(/["“”]/g,'').trim();
    const m = s.match(/,\s*([^,]+)\s*$/);
    if(m) return m[1].replace(/^(дом|д\.)\s*/i,'').trim();
    const m2 = s.match(/(\d+[0-9A-Za-zА-Яа-я\/\-]*?)\s*$/);
    return (m2 ? m2[1] : s);
  }
  function latLngWithPixelOffset(baseLatLng, dx, dy){
    const p = map.latLngToLayerPoint(baseLatLng);
    return map.layerPointToLatLng(L.point(p.x + dx, p.y + dy));
  }
  function placeLabelAtBuilding(layer){
    const addr = layer._address||'', company = layer._company||'';
    const color = colorByCompany(company);
    const text = extractHouse(addr);
    const b = layer.getBounds();
    const midLat = (b.getNorth()+b.getSouth())/2;
    const midLng = (b.getEast()+b.getWest())/2;
    const candidates = [
      {anchor: L.latLng(b.getNorth(), midLng), off:[0,-12]},
      {anchor: L.latLng(midLat, b.getEast()),  off:[+12,0]},
      {anchor: L.latLng(midLat, b.getWest()),  off:[-12,0]},
      {anchor: L.latLng(b.getSouth(), midLng), off:[0,+12]},
    ];
    let marker=null;
    for(const c of candidates){
      const pos = latLngWithPixelOffset(c.anchor, c.off[0], c.off[1]);
      const html = `<span class="hl" style="--hl-color:${color}">${escapeHtml(text)}</span>`;
      const icon = L.divIcon({ className:'house-label', html, iconSize: null });
      const mk = L.marker(pos, { icon, interactive:false, keyboard:false }).addTo(map);
      marker = mk; break;
    }
    marker._company = company;
    state.numberMarkers.push(marker);
  }
  function rebuildHouseLabels(){
    state.numberMarkers.forEach(m => map.removeLayer(m));
    state.numberMarkers = [];
    if(!$('#chkHnums').checked) return;
    state.layers.forEach(l => {
      if(l._address && l.getBounds && map.hasLayer(l)){
        placeLabelAtBuilding(l);
      }
    });
  }
  map.on('zoomend moveend', rebuildHouseLabels);
  $('#chkHnums').addEventListener('change', rebuildHouseLabels);

  // ===== Выбор домов =====
  function inSelectMode(){ return $('#chkSelectMode').checked; }

  function applySelectedStyle(layer){
    const base = colorByCompany(layer._company||'');
    layer.setStyle({ fillColor: base, color: '#111', weight: 4, dashArray: '6 3' });
  }
  function applyBaseStyle(layer){
    const base = colorByCompany(layer._company||'');
    layer.setStyle({ fillColor: base, color: base, weight: 2, dashArray: null });
  }
  function toggleLayerSelection(layer){
    if(!inSelectMode()) return;
    if(state.selected.has(layer)){
      state.selected.delete(layer);
      applyBaseStyle(layer);
    } else {
      state.selected.add(layer);
      applySelectedStyle(layer);
    }
    updateOnlySelectedVisibility();
    rebuildHouseLabels();
  }
  function clearSelection(){
    for(const l of state.selected) applyBaseStyle(l);
    state.selected.clear();
    updateOnlySelectedVisibility();
    rebuildHouseLabels();
  }
  $('#chkSelectMode').addEventListener('change', ()=>{/*просто режим*/});
  $('#btnClearSel').addEventListener('click', clearSelection);

  // Показать только выбранные
  document.getElementById('chkOnlySel').addEventListener('change', updateOnlySelectedVisibility);
  function updateOnlySelectedVisibility(){
    const only = $('#chkOnlySel').checked;
    if(only){
      // скрыть все, кто не выбран
      for(const l of state.layers){
        if(!state.selected.has(l) && map.hasLayer(l)){
          map.removeLayer(l);
          state.hidden.add(l);
        }
      }
    } else {
      // вернуть скрытые
      for(const l of state.hidden){
        if(!map.hasLayer(l)) l.addTo(map);
      }
      state.hidden.clear();
    }
    rebuildHouseLabels();
  }

  // Подсказка про прямоугольник
  document.getElementById('btnSelectBox').addEventListener('click', ()=>{
    alert('Удерживай Shift и перетаскивай по карте — дома в прямоугольнике будут выделены.');
  });
  map.on('boxzoomend', (e)=>{
    if(!inSelectMode()) return;
    const bounds = e.boxZoomBounds || e.bounds;
    if(!bounds) return;
    for(const l of state.layers){
      if(l.getBounds && bounds.intersects(l.getBounds())){
        state.selected.add(l);
        applySelectedStyle(l);
      }
    }
    updateOnlySelectedVisibility();
    rebuildHouseLabels();
  });

  // ===== Попапы =====
  function popupHtml({company, address, color, lat, lon}){
    const coord = (lat!=null&&lon!=null) ? `<div class='muted' style="margin-top:6px">${lat.toFixed(6)}, ${lon.toFixed(6)}</div>` : '';
    return `<div style="font-weight:700; margin-bottom:4px;">
        <span class="pill" style="border:1px solid ${color};">${escapeHtml(company||'(без компании)')}</span>
      </div>
      <div>${escapeHtml(address)}</div>${coord}`;
  }

  // ===== Построение =====
  function squareAround([lon, lat], meters = 30){
    const dLat = (meters / 111320);
    const dLon = (meters / (40075000 * Math.cos(lat*Math.PI/180) / 360));
    return [[lat+dLat, lon-dLon],[lat+dLat, lon+dLon],[lat-dLat, lon+dLon],[lat-dLat, lon-dLon]];
  }

  async function buildFromItems(items){
    clearAll();
    for(const item of items){
      const color = colorByCompany(item.company||'');
      try{
        const res = await geocode(item.address);
        if(!res){
          state.items.push({address:item.address, company:item.company||'', lat:null, lon:null});
          addListItem({...item, color});
          continue;
        }

        let latlng = null, poly = null;

        if(res.polygon){
          const ringLatLng = res.polygon.map(([lon,lat])=>[lat,lon]);
          poly = L.polygon(ringLatLng, { color: color, weight: 2, fillColor: color, fillOpacity: 0.9 }).addTo(map);
          latlng = poly.getBounds().getCenter();
        } else if(res.point){
          const [lon, lat] = res.point;
          let ring = null;
          try { ring = await fetchBuildingPolygon({ lon, lat }); } catch(e){ console.warn('Overpass fail', e); }
          if (ring && ring.length >= 4) {
            poly = L.polygon(ring, { color: color, weight: 2, fillColor: color, fillOpacity: 0.9 }).addTo(map);
            latlng = poly.getBounds().getCenter();
          } else {
            const sq = squareAround([lon,lat], 30).map(([la,lo])=>[la,lo]);
            poly = L.polygon(sq, { color: color, weight: 2, fillColor: color, fillOpacity: 0.9 }).addTo(map);
            const dot  = L.circleMarker([lat,lon], { radius: 4, color: '#fff', weight: 2, fillColor: color, fillOpacity: 1 }).addTo(map);
            state.layers.push(dot);
            latlng = [lat,lon];
          }
        }

        if(poly){
          poly._company = item.company || '';
          poly._address = item.address || '';
          poly.on('click', ()=> toggleLayerSelection(poly));
          state.layers.push(poly);

          const label = item.company || '';
          applyTooltip(poly, label);
          const _lat = latlng.lat!==undefined ? latlng.lat : latlng[0];
          const _lon = latlng.lng!==undefined ? latlng.lng : latlng[1];
          poly.bindPopup(popupHtml({company:item.company,address:item.address,color,lat:_lat,lon:_lon}));
          state.labelEntries.push({layer: poly, label});
        }

        if(latlng){
          const lat = latlng.lat!==undefined ? latlng.lat : latlng[0];
          const lon = latlng.lng!==undefined ? latlng.lng : latlng[1];
          item.lat = lat; item.lon = lon;
          state.bounds.extend([lat, lon]);
          state.items.push({address:item.address, company:item.company||'', lat, lon});
        } else {
          state.items.push({address:item.address, company:item.company||'', lat:null, lon:null});
        }
        addListItem({...item, color});
        await new Promise(r=>setTimeout(r,160));
      }catch(e){
        console.warn('Ошибка геокодинга', item.address, e);
        state.items.push({address:item.address, company:item.company||'', lat:null, lon:null});
        addListItem({...item, color});
      }
    }
    rebuildLegend();
    if(state.bounds.isValid()) map.fitBounds(state.bounds.pad(0.2));
    rebuildHouseLabels();
  }

  // ===== Генерация таблицы («наряда») =====
  function generatePrint(){
    const sel = Array.from(state.selected);
    if(sel.length===0){ alert('Не выбрано ни одного дома. Включи режим выбора и кликни по домам.'); return; }
    const rows = sel.map((l,i)=>({
      n: i+1,
      address: l._address||'',
      company: l._company||'',
      color: colorByCompany(l._company||'')
    }));
    const html = `<!doctype html>
<html><head><meta charset="utf-8">
<title>Наряд — выбранные адреса</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; margin:24px;}
  h1{font-size:20px;margin:0 0 12px;}
  .muted{color:#64748b;font-size:12px;margin-bottom:12px}
  table{border-collapse:collapse;width:100%;}
  th,td{border:1px solid #e5e7eb;padding:6px 8px;font-size:13px;text-align:left;vertical-align:top;}
  th{background:#f8fafc;}
  .sw{display:inline-block;width:14px;height:14px;border:1px solid rgba(0,0,0,.25);border-radius:3px;margin-right:6px;}
  .pill{display:inline-block;padding:1px 6px;border-radius:999px;border:1px solid #e5e7eb;background:#f1f5f9;font-size:12px}
  @media print{ .noprint{display:none} }
</style></head>
<body>
  <h1>Наряд — выбранные адреса</h1>
  <div class="muted">Цвета соответствуют компаниям на карте.</div>
  <table>
    <thead><tr><th>№</th><th>Адрес</th><th>Компания</th><th>Цвет</th></tr></thead>
    <tbody>
      ${rows.map(r=>`<tr>
        <td>${r.n}</td>
        <td>${escapeHtml(r.address)}</td>
        <td><span class="pill">${escapeHtml(r.company||'(без компании)')}</span></td>
        <td><span class="sw" style="background:${r.color}"></span>${r.color}</td>
      </tr>`).join('')}
    </tbody>
  </table>
  <div class="noprint" style="margin-top:12px;">
    <button onclick="window.print()">Печать</button>
  </div>
</body></html>`;
    const w = window.open('', '_blank');
    if(!w){ alert('Разреши всплывающие окна для печати.'); return; }
    w.document.open(); w.document.write(html); w.document.close();
  }
  document.getElementById('btnGenerate').addEventListener('click', generatePrint);

  // ===== Экспорт карты с ТОЛЬКО выбранными =====
  function coordsFromLatLngs(latlngs){
    if(Array.isArray(latlngs)){
      if(latlngs.length && latlngs[0] && typeof latlngs[0].lat === 'number'){
        return latlngs.map(p=>[p.lat, p.lng]);
      } else {
        return latlngs.map(coordsFromLatLngs);
      }
    }
    return latlngs;
  }
  function exportSelectedMap(){
    const sel = Array.from(state.selected);
    if(sel.length===0){ alert('Не выбрано ни одного дома.'); return; }
    const features = sel.map(l=>{
      const ll = l.getLatLngs ? l.getLatLngs() : [];
      return {
        address: l._address||'',
        company: l._company||'',
        color: colorByCompany(l._company||''),
        latlngs: coordsFromLatLngs(ll),
        bounds: l.getBounds ? l.getBounds() : null
      };
    });
    const html = `<!doctype html>
<html><head><meta charset="utf-8">
<title>Карта — выбранные дома</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  html,body{height:100%;margin:0}
  #wrap{display:grid;grid-template-columns:280px 1fr; height:100%;}
  #side{padding:14px;border-right:1px solid #eee;overflow:auto;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #mapx{height:100%;}
  h1{font-size:18px;margin:0 0 10px;}
  .muted{color:#64748b;font-size:12px;margin-bottom:12px}
  .legend{display:grid;grid-template-columns:auto 1fr; gap:6px 8px; font-size:13px;}
  .sw{width:16px;height:16px;border-radius:4px;border:1px solid rgba(0,0,0,.2)}
  .addr{margin-bottom:6px;font-size:13px}
  @media print{ .noprint{display:none} #wrap{grid-template-columns:0 1fr} #side{display:none} }
</style></head>
<body>
<div id="wrap">
  <div id="side">
    <h1>Выбранные дома</h1>
    <div class="muted">На карте показаны только они. Можно распечатать (Ctrl/Cmd+P).</div>
    <div id="leg" class="legend"></div>
    <hr>
    <div id="list"></div>
    <div class="noprint" style="margin-top:10px;"><button onclick="window.print()">Печать</button></div>
  </div>
  <div id="mapx"></div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"><\/script>
<script>
const data = ${JSON.stringify(features)};
function extractHouse(address){
  const s = String(address||'').replace(/["“”]/g,'').trim();
  const m = s.match(/,\\s*([^,]+)\\s*$/);
  if(m) return m[1].replace(/^(дом|д\\.)\\s*/i,'').trim();
  const m2 = s.match(/(\\d+[0-9A-Za-zА-Яа-я\\/\\-]*?)\\s*$/);
  return (m2 ? m2[1] : s);
}
const map = L.map('mapx', { zoomControl: true }).setView([51.533,46.033], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap'}).addTo(map);

const bounds = L.latLngBounds();
const companies = new Map();

function toLatLngs(arr){
  if(Array.isArray(arr) && arr.length && Array.isArray(arr[0]) && typeof arr[0][0]==='number'){
    return arr.map(p=>L.latLng(p[0],p[1]));
  }
  return arr.map(toLatLngs);
}
function placeEdgeLabel(layer, color, text){
  const b = layer.getBounds();
  const midLat = (b.getNorth()+b.getSouth())/2;
  const midLng = (b.getEast()+b.getWest())/2;
  const candidates = [
    {anchor: L.latLng(b.getNorth(), midLng), off:[0,-12]},
    {anchor: L.latLng(midLat, b.getEast()),  off:[+12,0]},
    {anchor: L.latLng(midLat, b.getWest()),  off:[-12,0]},
    {anchor: L.latLng(b.getSouth(), midLng), off:[0,+12]},
  ];
  const html = '<span class="hl" style="--hl-color:'+color+'">'+text.replace(/&/g,'&amp;').replace(/</g,'&lt;')+'</span>';
  const icon = L.divIcon({ className:'house-label', html, iconSize:null });
  const pos0 = map.layerPointToLatLng(map.latLngToLayerPoint(candidates[0].anchor).add([candidates[0].off[0],candidates[0].off[1]]));
  L.marker(pos0, { icon, interactive:false }).addTo(map);
}
data.forEach(f=>{
  const latlngs = toLatLngs(f.latlngs);
  const poly = L.polygon(latlngs, { color: f.color, weight:2, fillColor: f.color, fillOpacity:0.9 }).addTo(map);
  bounds.extend(poly.getBounds());
  const house = extractHouse(f.address);
  placeEdgeLabel(poly, f.color, house);
  companies.set(f.company||'(без компании)', f.color);
  const div = document.createElement('div');
  div.className='addr';
  div.innerHTML = '<span class="sw" style="background:'+f.color+'"></span> '+(f.company||'(без компании)')+' — '+f.address;
  document.getElementById('list').appendChild(div);
});
// легенда
const leg = document.getElementById('leg');
Array.from(companies.entries()).sort((a,b)=>a[0].localeCompare(b[0],'ru')).forEach(([name,col])=>{
  const sw = document.createElement('div'); sw.className='sw'; sw.style.background=col;
  const label = document.createElement('div'); label.textContent = name;
  leg.appendChild(sw); leg.appendChild(label);
});
if(bounds.isValid()) map.fitBounds(bounds.pad(0.15));
<\/script>
</body></html>`;
    const w = window.open('', '_blank');
    if(!w){ alert('Разреши всплывающие окна для экспорта карты.'); return; }
    w.document.open(); w.document.write(html); w.document.close();
  }
  document.getElementById('btnExportMap').addEventListener('click', exportSelectedMap);

  // ===== Обработчики =====
  document.getElementById('btnBuild').addEventListener('click', ()=>{
    const items = parseTextarea(document.getElementById('addrInput').value);
    buildFromItems(items);
  });
  document.getElementById('btnBuildFile').addEventListener('click', async ()=>{
    const f = document.getElementById('fileInput').files?.[0];
    if(!f){ alert('Выбери файл CSV/TSV'); return; }
    const text = await f.text();
    const items = parseCSV(text);
    if(items.length===0){ alert('Не удалось прочитать данные. Проверь колонки: Город, Адрес, Компания.'); return; }
    buildFromItems(items);
  });
  document.getElementById('btnClear').addEventListener('click', ()=>{
    document.getElementById('addrInput').value='';
    clearAll(); companyColor.clear(); rebuildLegend(); hidePicker();
  });
  document.getElementById('btnFit').addEventListener('click', ()=>{
    if(state.bounds.isValid()) map.fitBounds(state.bounds.pad(0.2));
  });

  // демо — один правильный пример (Рахова)
  document.getElementById('addrInput').value = [
    'г. Саратов, "улица Рахова, 169/171"',
    '000  Альфа'
  ].join('\n');
})();
</script>
</body>
</html>
