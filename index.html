<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞—Ä—Ç–∞ –º–æ–Ω—Ç–∞–∂–∞ ‚Äî GitHub Pages + JSON (Leaflet)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    #app { display:grid; grid-template-columns: 520px 1fr; height:100%; }
    #sidebar { padding:14px; border-right:1px solid #eee; overflow:auto; }
    #map { width:100%; height:100%; }
    .title { font-weight:700; }
    .muted { color:#667085; font-size:13px; }
    .panel { background:#fafafa; border:1px solid #eaeaea; border-radius:12px; padding:12px; margin-bottom:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="text"] { padding:8px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px; width:100%; }
    button { font-size:14px; padding:8px 10px; border:1px solid #e5e7eb; background:#fff; border-radius:8px; cursor:pointer; }
    button.primary { background:#111827; color:#fff; border-color:#111827; }
    button.ghost { background:#f8fafc; }
    .list { display:flex; flex-direction:column; gap:6px; }
    .item { padding:8px 10px; border:1px dashed #ddd; border-radius:10px; display:grid; grid-template-columns:1fr auto; gap:6px; align-items:center; }
    .item.active { background:#fff6e5; outline: 1px solid #fbbf24; }
    .item .act { display:flex; gap:6px; }
    .hint { font-size:12px; color:#475569; }
    .label { font-size:12px; color:#64748b; }
    .badge { font-size:12px; padding:2px 6px; border-radius:999px; background:#f1f5f9; border:1px solid #e5e7eb; }
    .house-label { background:transparent; border:none; transform:translate(-50%,-50%); pointer-events:none; }
    .house-label .hl { display:inline-block; padding:0 3px; font-size:9px; font-weight:700; background:rgba(255,255,255,.96); border:2px solid rgba(0,0,0,.25); border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,.10); line-height:1.1; white-space:nowrap; user-select:none; }
    .ok { color:#067647; } .danger { color:#b42318; }

    /* –ß–∏–ø—ã –≥–æ—Ä–æ–¥–æ–≤ */
    .chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .chip { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; user-select:none; }
    .chip.active { background:#111827; color:#fff; border-color:#111827; }

    /* –ò–Ω–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–æ—Ä */
    .inline-editor { grid-column: 1 / -1; background:#fff; border:1px solid #eee; border-radius:10px; padding:10px; display:none; }
    .inline-editor.open { display:block; }
    .inline-row { display:grid; grid-template-columns: 1fr; gap:8px; }
    .inline-actions { display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .inline-footer { display:flex; align-items:center; gap:8px; margin-top:8px; }

    /* –ü–æ–∏—Å–∫ */
    .tabs { display:flex; gap:6px; }
    .tab { padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; cursor:pointer; }
    .tab.active { background:#111827; color:#fff; border-color:#111827; }
    .search-wrap { display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; margin-top:8px; }
    .search-input { padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; font-size:14px; }
    .search-hint { font-size:12px; color:#64748b; }
    mark { background:#fef08a; padding:0 2px; border-radius:3px; }

    .suggest { margin-top:8px; display:flex; flex-direction:column; gap:6px; }
    .sg-item { border:1px dashed #e5e7eb; border-radius:10px; padding:8px; background:#fff; }
    .sg-top { display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .sg-title { font-weight:600; }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">

    <!-- üîé –ü–æ–∏—Å–∫ -->
    <div class="panel">
      <div class="title" style="margin-bottom:8px;">–ü–æ–∏—Å–∫</div>
      <div class="tabs">
        <span id="tabLocal" class="tab active">–í –±–∞–∑–µ</span>
        <span id="tabGlobal" class="tab">–ù–∞ –∫–∞—Ä—Ç–µ (OSM)</span>
      </div>
      <div class="search-wrap">
        <input id="searchBox" class="search-input" type="text" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º (‚åò/Ctrl+K)" />
        <button id="searchClear" class="ghost">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
      <div class="row" style="justify-content:space-between; margin-top:6px;">
        <div class="search-hint">Enter ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø–µ—Ä–≤–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é ‚Ä¢ Esc ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å</div>
        <span id="searchCount" class="badge"></span>
      </div>
      <!-- –ø–æ–¥—Å–∫–∞–∑–∫–∏ OSM -->
      <div id="suggestBox" class="suggest" style="display:none;"></div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="title">–ê–¥—Ä–µ—Å–∞ –∏–∑ –±–∞–∑—ã</div>
        <div class="row" style="gap:8px;">
          <button id="btnAdd" class="ghost">–î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å</button>
          <span id="countLbl" class="badge"></span>
        </div>
      </div>
      <div class="muted" id="loadMsg" style="margin-top:6px;"></div>

      <div class="label" style="margin-top:10px;">–§–∏–ª—å—Ç—Ä –ø–æ –≥–æ—Ä–æ–¥–∞–º</div>
      <div id="cityChips" class="chips"></div>

      <div class="list" id="itemsList" style="margin-top:10px;"></div>
    </div>

    <div class="panel" id="editPanel" style="display:none;"></div>

    <div class="panel">
      <div class="title" style="margin-bottom:6px;">–í–∏–¥</div>
      <div class="row">
        <button id="btnFit" class="ghost">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</button>
      </div>
      <div class="hint" style="margin-top:6px;">–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –≤—ã–∫–ª—é—á–∞–µ—Ç —Ä–∏—Å–æ–≤–∞–Ω–∏–µ.</div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
(function(){
  // --- –ö–∞—Ä—Ç–∞
  const map = L.map('map').setView([51.533, 46.033], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

  const $ = id => document.getElementById(id);
  const DEFAULT_COLOR = '#7c3aed';

  // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ
  const state = {
    db: {version:1, updated_at:new Date().toISOString(), items:[]},
    features: new Map(), // id -> polygon layer
    labels: [],
    selectedId: null,
    openItemId: null,

    relinkMode: false,
    previewLayer: null,

    drawMode: false,
    drawPoints: [],
    drawLayer: null,

    gh: null, // {repo, branch, path, token}
    cityFilter: new Set(), // –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ (–ø—É—Å—Ç–æ = –≤—Å–µ)

    // –ø–æ–∏—Å–∫
    searchMode: 'local', // 'local' | 'global'
    searchQuery: '',
    searchMarker: null
  };

  // --- Helpers
  const esc = s => String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const norm = s => String(s||'').toLowerCase().replaceAll('—ë','–µ').trim();
  const ringLonLat_to_LatLng = ring => ring.map(([x,y])=>[y,x]);
  const ringLatLng_to_LonLat = ring => ring.map(p=>[p.lng, p.lat]);

  function extractHouse(t){
    const s=String(t||'').trim();
    const m=s.match(/,\s*([^,]+)\s*$/); if(m) return m[1].replace(/^(–¥–æ–º|–¥\.)\s*/i,'').trim();
    const m2=s.match(/(\d+[0-9A-Za-z–ê-–Ø–∞-—è\/\-]*?)\s*$/); return m2?m2[1]:s;
  }

  function clearMap(){
    state.features.forEach(l=>map.removeLayer(l));
    state.features.clear();
    state.labels.forEach(m=>map.removeLayer(m)); state.labels=[];
  }
  function placeEdgeLabel(layer, text){
    const b=layer.getBounds();
    const pos = map.layerPointToLatLng(map.latLngToLayerPoint(L.latLng(b.getNorth(), (b.getEast()+b.getWest())/2)).add([0,-12]));
    const icon = L.divIcon({ className:'house-label', html:`<span class="hl">${esc(text||'')}</span>` });
    const mk = L.marker(pos, { icon, interactive:false }).addTo(map);
    state.labels.push(mk);
  }

  function drawItem(it){
    if(!Array.isArray(it.polygon) || it.polygon.length<3) return;
    const ll = ringLonLat_to_LatLng(it.polygon);
    const poly = L.polygon(ll, { color:DEFAULT_COLOR, weight:2, fillColor:DEFAULT_COLOR, fillOpacity:.9 }).addTo(map);
    poly.on('click', ()=>onPolygonClick(it.id));
    state.features.set(it.id, poly);
    placeEdgeLabel(poly, extractHouse(it.title));
  }

  function renderAll(){
    clearMap();
    state.db.items.forEach(drawItem);
    applyFiltersOnMap();
    renderCityChips();
    renderList();
  }

  const currentItem = () => state.db.items.find(x=>x.id===state.selectedId)||null;

  // ---------- –ü–æ–∏—Å–∫: UI
  const tabLocal = $('tabLocal');
  const tabGlobal = $('tabGlobal');
  const searchBox = $('searchBox');
  const searchClear = $('searchClear');
  const searchCount = $('searchCount');
  const suggestBox = $('suggestBox');

  tabLocal.onclick = ()=>{ state.searchMode='local'; tabLocal.classList.add('active'); tabGlobal.classList.remove('active'); suggestBox.style.display='none'; setSearch(searchBox.value); };
  tabGlobal.onclick = ()=>{ state.searchMode='global'; tabGlobal.classList.add('active'); tabLocal.classList.remove('active'); setSearch(searchBox.value); };

  function setSearch(v){
    state.searchQuery = v;
    if(state.searchMode==='local'){
      suggestBox.style.display='none';
      renderList(); applyFiltersOnMap();
    }else{
      renderList(); applyFiltersOnMap(); // —á—Ç–æ–±—ã —Å–∫—Ä—ã–≤–∞—Ç—å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª–∏–≥–æ–Ω—ã –ø—Ä–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –ø–æ–∏—Å–∫–µ —Ç–æ–∂–µ
      debouncedNominatim(v);
    }
  }

  searchBox.addEventListener('input', (e)=> setSearch(e.target.value));
  searchBox.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      if(state.searchMode==='local'){
        const first = document.querySelector('.item');
        if(first){ focusItem(first.dataset.id, {expand:true, scroll:true}); }
      }
    } else if(e.key==='Escape'){
      searchBox.value=''; setSearch('');
    }
  });
  searchClear.onclick = ()=>{ searchBox.value=''; setSearch(''); searchBox.focus(); };

  // –≥–ª–æ–±–∞–ª—å–Ω–∞—è –≥–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞
  window.addEventListener('keydown', (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='k'){
      e.preventDefault(); searchBox.focus(); searchBox.select();
    }
  });

  // ---------- Nominatim (OSM) ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∏
  let nomiTimer=null;
  async function nominatim(q){
    if(!q || q.trim().length<3){ suggestBox.style.display='none'; suggestBox.innerHTML=''; return; }
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('q', q);
    url.searchParams.set('format','jsonv2');
    url.searchParams.set('limit','8');
    url.searchParams.set('addressdetails','1');
    url.searchParams.set('accept-language','ru');

    const r = await fetch(url.toString(), { headers:{'Accept':'application/json'} });
    if(!r.ok) return;
    const arr = await r.json();

    suggestBox.style.display='';
    suggestBox.innerHTML = '';
    arr.forEach((it, idx)=>{
      const city = it.address?.city || it.address?.town || it.address?.village || it.address?.municipality || '';
      const road = it.address?.road || it.address?.pedestrian || it.address?.footway || '';
      const house = it.address?.house_number || '';
      const title = ['–≥. '+city, road && ('—É–ª. '+road), house].filter(Boolean).join(', ');
      const div = document.createElement('div');
      div.className='sg-item';
      div.innerHTML = `
        <div class="sg-top">
          <div class="sg-title">${esc(title || it.display_name)}</div>
          <button class="ghost sg-zoom">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
        <div class="muted" style="margin-top:4px;">${esc(it.display_name)}</div>
        <div class="row" style="margin-top:6px;">
          <button class="primary sg-add">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ –Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å</button>
        </div>
      `;
      const btnZoom = div.querySelector('.sg-zoom');
      const btnAdd  = div.querySelector('.sg-add');
      btnZoom.onclick = ()=> zoomToSuggestion(it);
      btnAdd.onclick  = ()=> addFromSuggestion(it);
      suggestBox.appendChild(div);
    });
    searchCount.textContent = `${arr.length} –≤ OSM`;
  }
  function debouncedNominatim(q){
    clearTimeout(nomiTimer);
    nomiTimer = setTimeout(()=>nominatim(q), 250);
  }

  function zoomToSuggestion(sg){
    const lat = +sg.lat, lon = +sg.lon;
    if(state.searchMarker){ map.removeLayer(state.searchMarker); state.searchMarker=null; }
    state.searchMarker = L.marker([lat,lon]).addTo(map).bindPopup(esc(sg.display_name)+'<br/><button id="ppAddBtn">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ –Ω–æ–≤—ã–π</button>').openPopup();
    map.setView([lat,lon], 18);
    // –∫–Ω–æ–ø–∫–∞ –≤ –ø–æ–ø–∞–ø–µ
    setTimeout(()=>{
      const btn = document.getElementById('ppAddBtn');
      if(btn) btn.onclick = ()=> addFromSuggestion(sg);
    }, 0);
  }

  async function addFromSuggestion(sg){
    const city = sg.address?.city || sg.address?.town || sg.address?.village || sg.address?.municipality || '';
    const road = sg.address?.road || sg.address?.pedestrian || sg.address?.footway || '';
    const house = sg.address?.house_number || '';
    const title = ['–≥. '+(city||'').trim(), road && ('—É–ª. '+road), house].filter(Boolean).join(', ').replace(/\s+,/g,',');

    const id = String(crypto?.randomUUID?.() || (Date.now()+Math.random()));
    const it = { id, title: title || sg.display_name, city: city || '', polygon: null };
    state.db.items.push(it);
    state.selectedId = id;
    state.openItemId = id;

    // –ø–æ–ø—Ä–æ–±—É–µ–º —Å—Ä–∞–∑—É –Ω–∞–π—Ç–∏ –∫–æ–Ω—Ç—É—Ä –∑–¥–∞–Ω–∏—è –≤–æ–∫—Ä—É–≥ —Ç–æ—á–∫–∏
    try{
      const ring = await fetchOverpassPolygon({lon:+sg.lon, lat:+sg.lat}, 400);
      if(ring){ it.polygon = ring; }
    }catch(_){}

    renderAll();
    scrollToItem(id);
  }

  // ---------- –°–ø–∏—Å–æ–∫ + —Ä–µ–¥–∞–∫—Ç–æ—Ä
  function matchesSearchLocal(it){
    if(state.searchMode!=='local' || !state.searchQuery) return true;
    const q = norm(state.searchQuery);
    const hay = norm(`${it.city} ${it.title}`);
    return hay.includes(q);
  }
  function highlightLocal(text){
    if(state.searchMode!=='local' || !state.searchQuery) return esc(text||'');
    const raw = String(text||'');
    const s = norm(raw), q = norm(state.searchQuery);
    const i = s.indexOf(q); if(i<0) return esc(raw);
    return esc(raw.slice(0,i)) + '<mark>' + esc(raw.slice(i, i + state.searchQuery.length)) + '</mark>' + esc(raw.slice(i + state.searchQuery.length));
  }

  function renderList(){
    const host = $('itemsList'); host.innerHTML='';
    const filtered = state.db.items.filter(it =>
      (state.cityFilter.size===0 || state.cityFilter.has((it.city||'').trim().toLowerCase()))
      && matchesSearchLocal(it)
    );

    $('countLbl').textContent = state.db.items.length;
    if(state.searchMode==='local'){ $('searchCount').textContent = `${filtered.length} —Å–æ–≤–ø–∞–¥.`; }

    filtered
      .slice()
      .sort((a,b)=> (a.city||'').localeCompare(b.city||'', 'ru') || (a.title||'').localeCompare(b.title||'', 'ru'))
      .forEach(it=>{
        const div=document.createElement('div');
        div.className='item' + (state.selectedId===it.id?' active':'');
        div.dataset.id = it.id;

        div.innerHTML = `
          <div class="title">${highlightLocal(it.title||'(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)')}</div>
          <div class="act">
            <button class="ghost" title="–ü–æ–∫–∞–∑–∞—Ç—å">–ü–æ–∫–∞–∑–∞—Ç—å</button>
            <button class="ghost" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
          </div>
          <div class="muted" style="grid-column:1 / -1">
            ${it.city ? highlightLocal(it.city) : '–ë–µ–∑ –≥–æ—Ä–æ–¥–∞'} ‚Ä¢ ${it.polygon && it.polygon.length>=3 ? '–ö–æ–Ω—Ç—É—Ä –µ—Å—Ç—å' : '–ö–æ–Ω—Ç—É—Ä –Ω–µ –∑–∞–¥–∞–Ω'}
          </div>
          <div class="inline-editor ${state.openItemId===it.id?'open':''}">
            <div class="inline-row">
              <div>
                <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                <input type="text" class="eTitle" value="${esc(it.title||'')}" />
              </div>
              <div>
                <div class="label">–ì–æ—Ä–æ–¥</div>
                <input type="text" class="eCity" value="${esc(it.city||'')}" />
              </div>
            </div>
            <div class="inline-actions">
              <button class="ghost btnRelink">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ OSM</button>
              <button class="ghost btnDraw">–ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é</button>
              <button class="ghost btnDrawFinish" style="display:none;">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ</button>
              <button class="ghost btnDrawUndo" style="display:none;">–û—Ç–º–µ–Ω–∏—Ç—å —Ç–æ—á–∫—É</button>
              <button class="ghost btnClearPoly">–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–∏–≥–æ–Ω</button>
            </div>
            <div class="inline-footer">
              <button class="primary btnSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="ghost btnCancel">–û—Ç–º–µ–Ω–∞</button>
              <span class="muted editMsg"></span>
            </div>
            <div class="hint modeHint" style="margin-top:6px;"></div>
          </div>
        `;

        const [btnShow, btnEdit] = div.querySelectorAll('.act button');
        const eTitle = div.querySelector('.eTitle');
        const eCity  = div.querySelector('.eCity');
        const btnRelink = div.querySelector('.btnRelink');
        const btnDraw = div.querySelector('.btnDraw');
        const btnDrawFinish = div.querySelector('.btnDrawFinish');
        const btnDrawUndo = div.querySelector('.btnDrawUndo');
        const btnClearPoly = div.querySelector('.btnClearPoly');
        const btnSave = div.querySelector('.btnSave');
        const btnCancel = div.querySelector('.btnCancel');
        const editMsg = div.querySelector('.editMsg');
        const modeHint = div.querySelector('.modeHint');

        btnShow.onclick = ()=>focusItem(it.id, {expand:false, scroll:true});
        btnEdit.onclick = ()=>{
          if(state.openItemId===it.id){ state.openItemId=null; }
          else { state.openItemId=it.id; state.selectedId=it.id; }
          stopRelink(); stopDraw(true);
          renderList();
          if(state.openItemId===it.id) div.scrollIntoView({block:'center', behavior:'smooth'});
        };

        btnRelink.onclick = ()=>{
          state.selectedId = it.id;
          stopDraw(true);
          state.relinkMode = true;
          modeHint.textContent = '–ö–ª–∏–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–µ —Ä—è–¥–æ–º —Å–æ –∑–¥–∞–Ω–∏–µ–º ‚Äî –Ω–∞–π–¥—ë–º –±–ª–∏–∂–∞–π—à–∏–π –∫–æ–Ω—Ç—É—Ä (OSM).';
        };
        btnDraw.onclick = ()=>{
          state.selectedId = it.id;
          stopRelink();
          startDraw(btnDrawFinish, btnDrawUndo, modeHint);
        };
        btnDrawFinish.onclick = ()=>{
          if(state.drawPoints.length<3) return alert('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏.');
          if(state.previewLayer) { map.removeLayer(state.previewLayer); state.previewLayer=null; }
          state.previewLayer = L.polygon(state.drawPoints, { color:'#111', weight:2, fillColor:DEFAULT_COLOR, fillOpacity:.5 }).addTo(map);
          stopDraw(false, btnDrawFinish, btnDrawUndo);
          modeHint.textContent='–ö–æ–Ω—Ç—É—Ä –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω. –ù–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.';
        };
        btnDrawUndo.onclick = ()=>{
          state.drawPoints.pop();
          if(state.drawLayer){ map.removeLayer(state.drawLayer); state.drawLayer=null; }
          if(state.drawPoints.length){
            const pts=state.drawPoints.slice(); if(pts.length>=3) pts.push(pts[0]);
            state.drawLayer=L.polyline(pts,{color:'#111',weight:2}).addTo(map);
          }
        };
        btnClearPoly.onclick = ()=>{
          const ref = state.db.items.find(x=>x.id===it.id);
          if(!ref) return;
          ref.polygon=null;
          state.db.updated_at=new Date().toISOString();
          renderAll();
          editMsg.textContent='–ü–æ–ª–∏–≥–æ–Ω —É–¥–∞–ª—ë–Ω (–ª–æ–∫–∞–ª—å–Ω–æ).';
        };

        btnSave.onclick = async ()=>{
          const ref = state.db.items.find(x=>x.id===it.id);
          if(!ref) return;
          ref.title = eTitle.value.trim();
          ref.city = eCity.value.trim();
          if(state.previewLayer){
            const ring = state.previewLayer.getLatLngs()[0];
            ref.polygon = ringLatLng_to_LonLat(ring);
          }
          state.db.updated_at = new Date().toISOString();

          stopRelink();
          stopDraw(true, btnDrawFinish, btnDrawUndo);
          if(state.previewLayer){ map.removeLayer(state.previewLayer); state.previewLayer=null; }

          try{
            const res = await saveDb();
            editMsg.className='muted ok';
            editMsg.textContent = res;
            state.openItemId = null;
            renderAll();
            state.selectedId = it.id;
            scrollToItem(it.id);
          }catch(err){
            editMsg.className='muted danger';
            editMsg.textContent = err.message;
          }
        };
        btnCancel.onclick = ()=>{
          stopRelink();
          stopDraw(true, btnDrawFinish, btnDrawUndo);
          if(state.previewLayer){ map.removeLayer(state.previewLayer); state.previewLayer=null; }
          state.openItemId = null;
          renderList(); scrollToItem(it.id);
        };

        host.appendChild(div);
      });

    if(state.selectedId) scrollToItem(state.selectedId);
  }

  function scrollToItem(id){
    const el = document.querySelector(`.item[data-id="${CSS.escape(id)}"]`);
    if(el) el.scrollIntoView({block:'center', behavior:'smooth'});
  }

  function focusItem(id, {expand=true, scroll=true} = {}){
    state.selectedId = id;
    const layer = state.features.get(id);
    if(layer && !map.hasLayer(layer)) layer.addTo(map);
    if(expand) state.openItemId = id;
    renderList();
    if(layer) map.fitBounds(layer.getBounds().pad(0.3));
    if(scroll) scrollToItem(id);
  }

  function onPolygonClick(id){ focusItem(id, {expand:true, scroll:true}); }

  // —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ –∫–∞—Ä—Ç–µ (–≥–æ—Ä–æ–¥ + –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫)
  function applyFiltersOnMap(){
    state.labels.forEach(m=>map.removeLayer(m)); state.labels=[];
    state.db.items.forEach(it=>{
      const layer = state.features.get(it.id);
      if(!layer) return;
      const passCity = (state.cityFilter.size===0) || state.cityFilter.has((it.city||'').trim().toLowerCase());
      const passSearch = (state.searchMode!=='local') || matchesSearchLocal(it);
      const pass = passCity && passSearch;
      if(pass){
        if(!map.hasLayer(layer)) layer.addTo(map);
        placeEdgeLabel(layer, extractHouse(it.title));
      } else {
        if(map.hasLayer(layer)) map.removeLayer(layer);
      }
    });
  }

  // --- –ß–∏–ø—ã –≥–æ—Ä–æ–¥–æ–≤
  function uniqueCities(){
    const set = new Set();
    state.db.items.forEach(it=>{
      const c = String(it.city||'').trim();
      if(c) set.add(c);
    });
    return Array.from(set).sort((a,b)=>a.localeCompare(b,'ru'));
  }
  function renderCityChips(){
    const host = $('cityChips'); host.innerHTML='';
    const all = document.createElement('span');
    all.className = 'chip' + (state.cityFilter.size===0 ? ' active':'');
    all.textContent = '–í—Å–µ';
    all.onclick = ()=>{ state.cityFilter.clear(); applyFiltersOnMap(); renderList(); renderCityChips(); };
    host.appendChild(all);

    uniqueCities().forEach(city=>{
      const key = city.trim().toLowerCase();
      const chip = document.createElement('span');
      chip.className = 'chip' + (state.cityFilter.has(key)?' active':'');
      chip.textContent = city;
      chip.onclick = ()=>{
        if(state.cityFilter.has(key)) state.cityFilter.delete(key); else state.cityFilter.add(key);
        applyFiltersOnMap(); renderList(); renderCityChips();
      };
      host.appendChild(chip);
    });
  }

  // --- –†–µ–∂–∏–º—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è/–ø—Ä–∏–≤—è–∑–∫–∏
  function stopRelink(){ state.relinkMode=false; if(state.previewLayer){ map.removeLayer(state.previewLayer); state.previewLayer=null; } }
  function startDraw(btnFinish, btnUndo, modeHintEl){
    state.drawMode=true; state.drawPoints=[]; if(state.drawLayer){ map.removeLayer(state.drawLayer); state.drawLayer=null; }
    if(btnFinish) btnFinish.style.display='';
    if(btnUndo) btnUndo.style.display='';
    if(modeHintEl) modeHintEl.textContent='–ö–ª–∏–∫–∞–π –ø–æ –∫–∞—Ä—Ç–µ, —Å—Ç–∞–≤—å —Ç–æ—á–∫–∏. ¬´–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ¬ª ‚Äî —á—Ç–æ–±—ã —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–∏–≥–æ–Ω.';
  }
  function stopDraw(clear, btnFinish, btnUndo){
    state.drawMode=false;
    if(btnFinish) btnFinish.style.display='none';
    if(btnUndo) btnUndo.style.display='none';
    if(clear){
      state.drawPoints=[];
      if(state.drawLayer){ map.removeLayer(state.drawLayer); state.drawLayer=null; }
    }
  }

  // --- –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ
  map.on('click', async (e)=>{
    if(state.drawMode){
      state.drawPoints.push(e.latlng);
      if(state.drawLayer){ map.removeLayer(state.drawLayer); state.drawLayer=null; }
      const pts=state.drawPoints.slice(); if(pts.length>=3) pts.push(pts[0]);
      state.drawLayer=L.polyline(pts,{color:'#111',weight:2}).addTo(map);
      return;
    }
    if(state.relinkMode){
      const ed = document.querySelector(`.item[data-id="${CSS.escape(state.selectedId||'')}"] .inline-editor .modeHint`);
      if(ed) ed.textContent='–ò—â—É –±–ª–∏–∂–∞–π—à–∏–π –∫–æ–Ω—Ç—É—Ä‚Ä¶';
      const ring = await fetchOverpassPolygon({lon:e.latlng.lng,lat:e.latlng.lat}, 500);
      if(!ring){ if(ed) ed.textContent='–ù–µ –Ω–∞—à—ë–ª –∫–æ–Ω—Ç—É—Ä. –ö–ª–∏–∫–Ω–∏ –±–ª–∏–∂–µ –∏ –ø–æ–≤—Ç–æ—Ä–∏.'; return; }
      if(state.previewLayer){ map.removeLayer(state.previewLayer); state.previewLayer=null; }
      state.previewLayer = L.polygon(ringLonLat_to_LatLng(ring), { color:'#111', weight:2, fillColor:DEFAULT_COLOR, fillOpacity:.5 }).addTo(map);
      map.fitBounds(state.previewLayer.getBounds().pad(0.2));
      if(ed) ed.textContent='–ö–æ–Ω—Ç—É—Ä –Ω–∞–π–¥–µ–Ω. –ù–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.';
    }
  });
  map.on('dblclick', ()=>{
    if(state.drawMode){
      const wrap = document.querySelector(`.item[data-id="${CSS.escape(state.selectedId||'')}"] .inline-editor`);
      const btnFinish = wrap?.querySelector('.btnDrawFinish');
      const btnUndo   = wrap?.querySelector('.btnDrawUndo');
      stopDraw(true, btnFinish, btnUndo);
      const hint = wrap?.querySelector('.modeHint');
      if(hint) hint.textContent='–†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.';
    }
  });

  $('btnAdd').onclick = ()=>{
    const id = String(crypto?.randomUUID?.() || (Date.now()+Math.random()));
    const it = { id, title:'–ù–æ–≤—ã–π –∞–¥—Ä–µ—Å', city:'', polygon:null };
    state.db.items.push(it);
    state.selectedId = id;
    state.openItemId = id; // —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä
    renderAll(); scrollToItem(id);
  };

  $('btnFit').onclick = ()=>{ map.fitWorld(); };

  // --- Overpass helper (–ø–æ–∏—Å–∫ –∫–æ–Ω—Ç—É—Ä–∞ –∑–¥–∞–Ω–∏—è)
  async function fetchOverpassPolygon({ lon, lat }, radius = 500){
    const EPS=['https://overpass.kumi.systems/api/interpreter','https://overpass-api.de/api/interpreter','https://overpass.openstreetmap.ru/api/interpreter'];
    const q=`[out:json][timeout:60];(way["building"](around:${radius},${lat},${lon});relation["building"](around:${radius},${lat},${lon}););out body geom;`;
    for(const ep of EPS){
      try{
        const r=await fetch(ep,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},body:new URLSearchParams({data:q})});
        if(!r.ok) continue;
        const j=await r.json(); const a=j.elements||[]; if(!a.length) continue;
        let best=null, bestD=Infinity;
        for(const el of a){
          const g=el.geometry; if(!Array.isArray(g)||g.length<4) continue;
          const ring=g.map(p=>[p.lon,p.lat]);
          let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
          ring.forEach(([x,y])=>{ if(x<minX)minX=x; if(x>maxX)maxX=x; if(y<minY)minY=y; if(y>maxY)maxY=y; });
          const cx=(minX+maxX)/2, cy=(minY+maxY)/2;
          const d=(cx-lon)*(cx-lon)+(cy-lat)*(cy-lat);
          if(d<bestD){bestD=d;best=ring;}
        }
        if(best){ const f=best[0], l=best[best.length-1]; if(f[0]!==l[0]||f[1]!==l[1]) best.push([f[0],f[1]]); return best; }
      }catch(e){ /* try next */ }
    }
    return null;
  }

  // --- –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã
  function normalizeDb(j){
    return {
      version: j.version||1,
      updated_at: j.updated_at || new Date().toISOString(),
      items: Array.isArray(j.items) ? j.items.map(x=>({
        id: String(x.id || (crypto?.randomUUID?.() || (Date.now()+Math.random()))),
        title: x.title || '',
        city: x.city || '',
        polygon: Array.isArray(x.polygon) ? x.polygon : null
      })) : []
    };
  }
  async function loadDbFromUrl(url){
    const bust = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
    const r = await fetch(bust, { cache:'no-store', headers:{'Accept':'application/json'} });
    if(!r.ok) throw new Error('HTTP '+r.status);
    state.db = normalizeDb(await r.json());
    renderAll();
  }

  // --- GitHub API (—Å —Ä–µ—Ç—Ä–∞–µ–º 409)
  function parseGhFromHash(){
    const h = new URLSearchParams(location.hash.slice(1));
    const gh = h.get('gh'); const token = h.get('token');
    if(!gh || !token) return null;
    const [repoPart, bp] = gh.split('@');
    const [branch, ...pathParts] = (bp||'main:database.json').split(':');
    const path = pathParts.join(':') || 'database.json';
    return { repo: repoPart, branch, path, token };
  }
  function encodePathForContentsAPI(path){ return path.split('/').map(encodeURIComponent).join('/'); }
  function toBase64Unicode(str){
    const bytes = new TextEncoder().encode(str);
    let bin = ''; const CHUNK = 0x8000;
    for (let i = 0; i < bytes.length; i += CHUNK) { bin += String.fromCharCode(...bytes.subarray(i, i + CHUNK)); }
    return btoa(bin);
  }
  async function ghGetSha({repo,branch,path,token}){
    const url = `https://api.github.com/repos/${repo}/contents/${encodePathForContentsAPI(path)}?ref=${encodeURIComponent(branch)}`;
    const r = await fetch(url, { method:'GET', headers:{ 'Authorization':`Bearer ${token}`, 'Accept':'application/vnd.github+json', 'X-GitHub-Api-Version':'2022-11-28' } });
    if(r.status===404) return null;
    if(!r.ok){ const t=await r.text().catch(()=> ''); throw new Error(`GitHub GET ${r.status}: ${t}`); }
    const j = await r.json(); return j.sha || null;
  }
  async function ghPut({repo,branch,path,token}, content, sha){
    const url = `https://api.github.com/repos/${repo}/contents/${encodePathForContentsAPI(path)}`;
    const body = { message:`update ${path} via leaflet`, branch, content: toBase64Unicode(content), ...(sha?{sha}:{}) };
    const r = await fetch(url, { method:'PUT', headers:{ 'Authorization':`Bearer ${token}`, 'Accept':'application/vnd.github+json', 'Content-Type':'application/json', 'X-GitHub-Api-Version':'2022-11-28' }, body: JSON.stringify(body) });
    if(!r.ok){ const txt=await r.text().catch(()=> ''); const err=new Error(`GitHub PUT ${r.status}: ${txt||'Failed to save'}`); err._status=r.status; throw err; }
    return await r.json();
  }
  async function saveDb(){
    const content = JSON.stringify({ ...state.db, updated_at:new Date().toISOString() }, null, 2);
    if(state.gh){
      let sha = await ghGetSha(state.gh);
      try{
        const res = await ghPut(state.gh, content, sha || undefined);
        return `–ì–æ—Ç–æ–≤–æ: –∫–æ–º–º–∏—Ç ${res.commit?.sha?.slice(0,7) || ''} –≤ ${state.gh.repo}/${state.gh.branch}`;
      }catch(e){
        if(e?._status === 409){
          sha = await ghGetSha(state.gh);
          const res = await ghPut(state.gh, content, sha || undefined);
          return `–ì–æ—Ç–æ–≤–æ: –∫–æ–º–º–∏—Ç ${res.commit?.sha?.slice(0,7) || ''} (–ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è sha)`;
        }
        throw e;
      }
    }
    const blob = new Blob([content], {type:'application/json;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'database.json'; a.click(); URL.revokeObjectURL(a.href);
    throw new Error('–°–∫–∞—á–∞–Ω –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π database.json ‚Äî –∑–∞–º–µ–Ω–∏ –µ–≥–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.');
  }

  // --- Boot
  (async function boot(){
    const param = new URLSearchParams(location.search).get('data');
    state.gh = parseGhFromHash();
    if(state.gh){ $('loadMsg').textContent = `–†–µ–∂–∏–º GitHub: ${state.gh.repo} @ ${state.gh.branch} ‚Üí ${state.gh.path}`; }
    else { $('loadMsg').textContent = `–†–µ–∂–∏–º Pages: —á–∏—Ç–∞–µ–º ./database.json (–±–µ–∑ –∫—ç—à–∞)`; }
    try{
      const baseUrl = param || new URL('database.json', location.href).toString();
      await loadDbFromUrl(baseUrl);
    }catch(e){
      $('loadMsg').textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É. –£–±–µ–¥–∏—Å—å, —á—Ç–æ database.json –ª–µ–∂–∏—Ç —Ä—è–¥–æ–º —Å index.html (–≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ/–≤–µ—Ç–∫–µ Pages).';
      console.warn(e);
    }
  })();

  // –ø–æ–¥–ø–∏—Å–∏ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏/–∑—É–º–µ
  map.on('moveend zoomend', ()=>{
    state.labels.forEach(m=>map.removeLayer(m)); state.labels=[];
    state.features.forEach(l=>{
      const it = state.db.items.find(x=>x.id===Array.from(state.features.entries()).find(([id,lay])=>lay===l)?.[0]);
      if(it && map.hasLayer(l)) placeEdgeLabel(l, extractHouse(it?.title));
    });
  });
})();
</script>
</body>
</html>
