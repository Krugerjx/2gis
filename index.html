<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Карта монтажа — подсветка домов (2ГИС)</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    #app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
    #sidebar { padding: 14px; border-right: 1px solid #eee; overflow: auto; }
    #map { width: 100%; height: 100%; }
    .panel { background: #fafafa; border: 1px solid #eaeaea; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row input, .row button, textarea { font-size: 14px; }
    textarea { width: 100%; min-height: 120px; resize: vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; }
    .legend { display: grid; grid-template-columns: 1fr auto; gap: 6px 10px; font-size: 13px; }
    .swatch { width: 18px; height: 18px; border-radius: 4px; border: 1px solid rgba(0,0,0,.15); }
    .item { padding: 8px 10px; border-radius: 10px; border: 1px dashed #ddd; margin-bottom: 6px; cursor: pointer; }
    .muted { color: #666; font-size: 13px; }
    .pill { padding: 2px 6px; border-radius: 999px; font-size: 12px; background: #f1f5f9; border: 1px solid #e5e7eb; }
  </style>
  <script src="https://mapgl.2gis.com/api/js/v1"></script>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="panel">
      <div style="font-weight:700;">Карта монтажа — 2ГИС</div>
      <div class="muted">Вставь адреса → «Построить». Понимает и 6-колоночный формат.</div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Ключ API 2ГИС</div>
      <input id="apiKey" type="password" placeholder="Вставьте ключ 2ГИС" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd;" />
      <div class="muted" style="margin-top:6px;">Нужны сервисы: <b>MapGL JS API</b> и <b>Catalog API</b>. Можно оставить поле пустым — возьмётся ключ из кода.</div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Адреса</div>
      <textarea id="addrInput" placeholder="Форматы:
• Адрес[TAB]Статус[TAB]#Цвет
• ID  ID2  Город  Улица  Дом  Подъезд  (через пробелы/табы). Статус = 'Подъезд N'."></textarea>
      <div class="row" style="margin-top:8px;">
        <button id="btnBuild">Построить</button>
        <button id="btnClear">Очистить</button>
        <button id="btnFit">Показать все</button>
      </div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Легенда статусов</div>
      <div id="legend" class="legend"></div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Найденные точки</div>
      <div id="list"></div>
    </div>
  </div>
  <div id="map"></div>
</div>

<script>
(function(){
  // === ТВОЙ КЛЮЧ 2ГИС УЖЕ В КОДЕ ===
  // Можно переопределить в URL: ?key=ВАШ_КЛЮЧ
  // Если увидишь 403 при геокоде — включи "Catalog API" на этом ключе в platform.2gis.ru
  const DEFAULT_KEY = 'b071d8db-8fa6-4a9f-927e-85145f520db9';
  const URL_KEY = new URLSearchParams(location.search).get('key') || '';
  const KEY = URL_KEY || DEFAULT_KEY;

  const $ = (s)=>document.querySelector(s);

  const state = { map:null, layers:[], statusColor:new Map(), bounds:{ minLon:+Infinity, minLat:+Infinity, maxLon:-Infinity, maxLat:-Infinity } };

  function updateBounds([lon,lat]){ const b=state.bounds; b.minLon=Math.min(b.minLon,lon); b.minLat=Math.min(b.minLat,lat); b.maxLon=Math.max(b.maxLon,lon); b.maxLat=Math.max(b.maxLat,lat); }
  function fitToAll(){ const {minLon,minLat,maxLon,maxLat}=state.bounds; if(!isFinite(minLon))return; const center=[(minLon+maxLon)/2,(minLat+maxLat)/2]; state.map.setCenter(center); const span=Math.max(Math.abs(maxLon-minLon),Math.abs(maxLat-minLat)); let z=14; if(span>0.5)z=10; else if(span>0.2)z=11; else if(span>0.1)z=12; else if(span>0.05)z=13; else if(span>0.02)z=14; else if(span>0.01)z=15; else z=16; state.map.setZoom(z); }

  function ensureMap(){ if(state.map) return; state.map=new mapgl.Map('map',{ center:[46.033,51.533], zoom:12, key: KEY }); }
  function clearAll(){ state.layers.forEach(o=>{ try{o.destroy&&o.destroy();}catch(e){} }); state.layers=[]; state.bounds={ minLon:+Infinity, minLat:+Infinity, maxLon:-Infinity, maxLat:-Infinity }; $('#list').innerHTML=''; }

  function addLegendRow(s,c){ const host=$('#legend'); const t=document.createElement('div'); t.textContent=s||'(без статуса)'; const sw=document.createElement('div'); sw.className='swatch'; sw.style.background=c||'#7c3aed'; host.appendChild(t); host.appendChild(sw); }
  function rebuildLegend(){ const host=$('#legend'); host.innerHTML=''; const arr=Array.from(state.statusColor.entries()); if(!arr.length){ addLegendRow('Адреса','#7c3aed'); return;} arr.forEach(([s,c])=>addLegendRow(s,c)); }

  // Преобразуем цвет в полупрозрачный (работает и с #rrggbb, и с hsl(...))
  function withAlpha(color, a){
    if(/^#([0-9a-f]{6})$/i.test(color)){
      const r=parseInt(color.slice(1,3),16), g=parseInt(color.slice(3,5),16), b=parseInt(color.slice(5,7),16);
      return `rgba(${r},${g},${b},${a})`;
    }
    if(/^hsl\(/i.test(color)){
      return color.replace(/^hsl/i,'hsla').replace(/\)$/,`, ${a})`);
    }
    // fallback: оставим как есть (без прозрачности)
    return color;
  }

  function drawPolygon(coords,opts){
    const p=new mapgl.Polygon(state.map,{
      coordinates:[coords],
      strokeWidth:2,
      strokeColor:opts.strokeColor||'#222',
      color:opts.fill||withAlpha(opts.strokeColor||'#222',0.35)
    });
    state.layers.push(p); return p;
  }
  function drawMarker(point,html){ const m=new mapgl.HtmlMarker(state.map,{ coordinates:point, html: html||'<div style="width:10px;height:10px;border-radius:50%;background:#111"></div>' }); state.layers.push(m); return m; }

  function addListItem(item){
    const el=document.createElement('div');
    el.className='item';
    el.innerHTML=`<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
      <div style="font-weight:600">${escapeHtml(item.address)}</div>
      ${item.status?`<span class='pill' style='border:1px solid ${item.color||'#ddd'}'>${escapeHtml(item.status)}</span>`:''}
    </div><div class='muted'>${item.lat&&item.lon?`${item.lat.toFixed(6)}, ${item.lon.toFixed(6)}`:'—'}</div>`;
    el.addEventListener('click',()=>{ if(item.lon&&item.lat){ state.map.setCenter([item.lon,item.lat]); state.map.setZoom(17);} });
    $('#list').appendChild(el);
  }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // --- Parser ---
  function parseInput(text){
    const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const out=[];
    for(const line of lines){
      // 6-колонок: ID ID2 City Street House Entrance
      const m6=/^(\S+)\s+(\S+)\s+(\S+)\s+(.+?)\s+(\S+)\s+(\S+)$/.exec(line);
      if(m6){ const city=m6[3], street=m6[4], house=m6[5], entr=m6[6]; out.push({ address:`${city}, ${street} ${house}`, status:`Подъезд ${entr}`, color:'' }); continue; }
      // Табами: Адрес \t Статус \t Цвет
      const tab=line.split(/\t/);
      if(tab.length>=1){ out.push({ address:tab[0]?.trim(), status:tab[1]?.trim()||'', color:(tab[2]?.trim()||'').toLowerCase() }); continue; }
    }
    return out;
  }

  // --- 2GIS Catalog API geocode ---
  async function geocode2GIS(key,q){
    const url=new URL('https://catalog.api.2gis.com/3.0/items/geocode');
    url.searchParams.set('q',q);
    url.searchParams.set('fields','items.point,items.geometry');
    url.searchParams.set('key',key);
    const r=await fetch(url.toString());
    if(!r.ok) throw new Error('Catalog API error: '+r.status);
    const j=await r.json();
    const it=j?.result?.items?.[0];
    if(!it) return null;
    const point=it.point?[it.point.lon,it.point.lat]:null;
    let polygonCoords=null; const g=it.geometry;
    if(g && g.selection && Array.isArray(g.selection.contours)){
      const c=g.selection.contours[0].points;
      if(Array.isArray(c)&&c.length){ polygonCoords=c.map(p=>[p[0]??p.lon??p.x,p[1]??p.lat??p.y]); }
    } else if(g && g.coordinates){
      const arr=g.coordinates?.[0];
      if(Array.isArray(arr)&&arr.length){ polygonCoords=arr.map(pt=>[pt[0],pt[1]]); }
    }
    return { point, polygonCoords };
  }

  function ensureColor(item){
    if(item.color) return item.color; // #hex, hsl(...) — как дали
    if(!item.status) return '#7c3aed';
    if(state.statusColor.has(item.status)) return state.statusColor.get(item.status);
    const h=Math.abs(hash(item.status))%360;
    const c=`hsl(${h} 90% 45%)`; // понасыщенней, дальше сделаем прозрачность через withAlpha
    state.statusColor.set(item.status,c);
    return c;
  }
  function hash(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return h; }

  async function build(){
    const key = (document.getElementById('apiKey').value.trim() || KEY);
    if(!key){ alert('Нет ключа 2ГИС'); return; }
    clearAll();

    const items=parseInput(document.getElementById('addrInput').value);
    for(const item of items){
      const color=ensureColor(item);
      try{
        const res=await geocode2GIS(key,item.address);
        if(!res){ addListItem(item); continue; }

        if(res.polygonCoords){
          drawPolygon(res.polygonCoords,{ fill: withAlpha(color,0.35), strokeColor: color });
          const centroid=res.polygonCoords.reduce((a,p)=>[a[0]+p[0],a[1]+p[1]],[0,0]).map(v=>v/res.polygonCoords.length);
          item.lon=centroid[0]; item.lat=centroid[1]; updateBounds(centroid);
          drawMarker(centroid,`<div style="width:12px;height:12px;border-radius:999px;border:2px solid #fff;background:${color};box-shadow:0 0 0 2px ${withAlpha(color,0.35)}"></div>`);
        } else if(res.point){
          item.lon=res.point[0]; item.lat=res.point[1]; updateBounds(res.point);
          drawMarker(res.point,`<div style="width:14px;height:14px;border-radius:999px;border:2px solid #fff;background:${color};box-shadow:0 0 0 2px ${withAlpha(color,0.35)}"></div>`);
        }
        addListItem(item);
        await new Promise(r=>setTimeout(r,120));
      }catch(e){
        console.warn('Ошибка геокодинга', item.address, e);
        addListItem(item);
      }
    }
    rebuildLegend(); fitToAll();
  }

  ensureMap();
  if(KEY) document.getElementById('apiKey').value = KEY;
  document.getElementById('btnBuild').addEventListener('click', build);
  document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('addrInput').value=''; clearAll(); rebuildLegend(); });
  document.getElementById('btnFit').addEventListener('click', fitToAll);

  // демо-ввод
  document.getElementById('addrInput').value = [
    '12\t970\tСаратов\t1-я Беговая\t13\t4',
    '20\t772\tСаратов\t1-й Кавказский\t10\t4'
  ].join('\n');
})();
</script>
</body>
</html>
