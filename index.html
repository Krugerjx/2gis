<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞—Ä—Ç–∞ –º–æ–Ω—Ç–∞–∂–∞ ‚Äî –ë–∞–∑–∞ + –ù–∞—Ä—è–¥—ã (Leaflet, GitHub JSON)</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- SheetJS (XLSX/CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    #app { display:grid; grid-template-columns: 560px 1fr; height:100%; }
    #sidebar { padding:14px; border-right:1px solid #eee; overflow:auto; }
    #map { width:100%; height:100%; }

    .title { font-weight:700; }
    .muted { color:#667085; font-size:13px; }
    .panel { background:#fafafa; border:1px solid #eaeaea; border-radius:12px; padding:12px; margin-bottom:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="text"], input[type="color"], input[type="number"] { padding:8px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px; }
    input[type="text"].w100 { width:100%; }
    button { font-size:14px; padding:8px 10px; border:1px solid #e5e7eb; background:#fff; border-radius:8px; cursor:pointer; }
    button.primary { background:#111827; color:#fff; border-color:#111827; }
    button.ghost { background:#f8fafc; }
    button.danger { background:#fee2e2; border-color:#fecaca; color:#991b1b; }
    .badge { font-size:12px; padding:2px 6px; border-radius:999px; background:#f1f5f9; border:1px solid #e5e7eb; }

    .list { display:flex; flex-direction:column; gap:6px; }
    .item { padding:8px 10px; border:1px dashed #ddd; border-radius:10px; display:grid; grid-template-columns:auto 1fr auto; gap:8px; align-items:center; }
    .item.active { background:#fff6e5; outline: 1px solid #fbbf24; }
    .item .act { display:flex; gap:6px; }
    .label { font-size:12px; color:#64748b; }
    .hint { font-size:12px; color:#475569; }
    mark { background:#fef08a; padding:0 2px; border-radius:3px; }

    /* –ß–∏–ø—ã –≥–æ—Ä–æ–¥–æ–≤ */
    .chips { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .chip { font-size:12px; padding:4px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; user-select:none; }
    .chip.active { background:#111827; color:#fff; border-color:#111827; }

    /* –ü–æ–¥–ø–∏—Å–∏ –¥–æ–º–æ–≤ */
    .house-label { background:transparent; border:none; transform:translate(-50%,-50%); pointer-events:none; }
    .house-label .hl { display:inline-block; padding:0 3px; font-size:9px; font-weight:700; background:rgba(255,255,255,.96); border:2px solid rgba(0,0,0,.25); border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,.10); line-height:1.1; white-space:nowrap; user-select:none; }

    .ok { color:#067647; } .dangerText { color:#b42318; }

    /* –¢–∞–±–ª–∏—Ü–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π */
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { border-bottom:1px solid #eee; padding:6px 8px; text-align:left; }
    tr.miss td { background:#fff1f2; }
    tr.hit td { background:#f0fdf4; }

    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ */
    .vis { display:flex; align-items:center; gap:6px; }
    .vis input { width:16px; height:16px; }

    /* –ü—Ä–∏–Ω—Ç */
    @media print { #sidebar { display:none; } #app { grid-template-columns: 1fr; } }

    /* –ü–æ–∏—Å–∫ */
    .tabs { display:flex; gap:6px; }
    .tab { padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px; cursor:pointer; }
    .tab.active { background:#111827; color:#fff; border-color:#111827; }
    .search-wrap { display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; margin-top:8px; }
    .search-input { padding:10px 12px; border-radius:10px; border:1px solid #e5e7eb; font-size:14px; width:100%; }
    .search-hint { font-size:12px; color:#64748b; }
    .suggest { margin-top:8px; display:flex; flex-direction:column; gap:6px; }
    .sg-item { border:1px dashed #e5e7eb; border-radius:10px; padding:8px; background:#fff; }
    .sg-top { display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .sg-title { font-weight:600; }

    /* –ò–Ω–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–æ—Ä */
    .inline-editor { grid-column: 1 / -1; background:#fff; border:1px solid #eee; border-radius:10px; padding:10px; display:none; }
    .inline-editor.open { display:block; }
    .inline-row { display:grid; grid-template-columns: 1fr; gap:8px; }
    .inline-actions { display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
    .inline-footer { display:flex; align-items:center; gap:8px; margin-top:8px; }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">

    <!-- üîé –ü–æ–∏—Å–∫ -->
    <div class="panel">
      <div class="title" style="margin-bottom:8px;">–ü–æ–∏—Å–∫</div>
      <div class="tabs">
        <span id="tabLocal" class="tab active">–í –±–∞–∑–µ</span>
        <span id="tabGlobal" class="tab">–ù–∞ –∫–∞—Ä—Ç–µ (OSM)</span>
      </div>
      <div class="search-wrap">
        <input id="searchBox" class="search-input" type="text" placeholder="–ì–æ—Ä–æ–¥, —É–ª–∏—Ü–∞, –¥–æ–º (‚åò/Ctrl+K)" />
        <button id="searchClear" class="ghost">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
      <div class="row" style="justify-content:space-between; margin-top:6px;">
        <div class="search-hint">Enter ‚Äî –∫ –ø–µ—Ä–≤–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é ‚Ä¢ Esc ‚Äî –æ—á–∏—Å—Ç–∏—Ç—å</div>
        <span id="searchCount" class="badge"></span>
      </div>
      <div id="suggestBox" class="suggest" style="display:none;"></div>
    </div>

    <!-- üóÇ –ï–¥–∏–Ω–∞—è –±–∞–∑–∞ -->
    <div class="panel">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="title">–ï–¥–∏–Ω–∞—è –±–∞–∑–∞</div>
        <div class="row">
          <button id="btnToggleBase" class="ghost">–°–≤–µ—Ä–Ω—É—Ç—å –∞–¥—Ä–µ—Å–∞ –±–∞–∑—ã</button>
          <button id="btnAddBase" class="ghost">–î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å</button>
          <span id="countLbl" class="badge"></span>
        </div>
      </div>
      <div class="muted" id="loadMsg" style="margin-top:6px;"></div>
      <div class="label" style="margin-top:10px;">–§–∏–ª—å—Ç—Ä –ø–æ –≥–æ—Ä–æ–¥–∞–º</div>
      <div id="cityChips" class="chips"></div>
      <div class="list" id="itemsList" style="margin-top:10px;"></div>
    </div>

    <!-- ‚úèÔ∏è –ò–Ω–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–æ—Ä –∞–¥—Ä–µ—Å–∞ -->
    <div class="panel" id="editPanel" style="display:none;"></div>

    <!-- üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∫–ª–∏–µ–Ω—Ç–∞ -->
    <div class="panel">
      <div class="title">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∫–ª–∏–µ–Ω—Ç–∞ (XLSX/CSV) ‚Üí –ù–∞—Ä—è–¥</div>
      <div class="hint" style="margin-top:6px;">–û–∂–∏–¥–∞—é—Ç—Å—è —Å—Ç–æ–ª–±—Ü—ã: <b>–ê–¥—Ä–µ—Å</b> –∏ <b>–ö–æ–ª</b>.</div>
      <div class="row" style="margin-top:8px;">
        <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" />
        <button id="btnClearUpload" class="ghost">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
      <div id="uploadStats" class="muted" style="margin-top:6px;"></div>
      <div id="matchTableWrap" style="margin-top:8px; display:none;">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div class="label">–°–æ–≤–ø–∞–¥–µ–Ω–∏—è –∞–¥—Ä–µ—Å–æ–≤ —Å –±–∞–∑–æ–π</div>
          <div class="row">
            <input id="companyInput" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏" />
            <input id="colorInput" type="color" value="#e11d48" title="–¶–≤–µ—Ç" />
            <button id="btnCreateOrder" class="primary">–°–æ–∑–¥–∞—Ç—å –Ω–∞—Ä—è–¥</button>
          </div>
        </div>
        <div class="hint" style="margin-top:6px;">–ö—Ä–∞—Å–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ ‚Äî –∞–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–µ–ª—ë–Ω—ã–µ ‚Äî –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –Ω–∞—Ä—è–¥.</div>
        <div style="max-height:220px; overflow:auto; margin-top:8px;">
          <table id="matchTable"></table>
        </div>
      </div>
    </div>

    <!-- üì¶ –ù–∞—Ä—è–¥—ã -->
    <div class="panel">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="title">–°–æ–±—Ä–∞–Ω–Ω—ã–µ –Ω–∞—Ä—è–¥—ã</div>
        <div class="row">
          <button id="btnAddManual" class="ghost">+ –ù–æ–≤—ã–π (–≤—Ä—É—á–Ω—É—é)</button>
          <button id="btnSaveNaryad" class="ghost">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å naryad.json</button>
          <input id="naryadLoad" type="file" accept=".json" style="display:none;" />
          <button id="btnLoadNaryad" class="ghost">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </div>
      </div>
      <div id="ordersList" class="list" style="margin-top:8px;"></div>
    </div>

    <!-- üîß –†–µ–¥–∞–∫—Ç–æ—Ä –Ω–∞—Ä—è–¥–∞ -->
    <div class="panel" id="orderEditPanel" style="display:none;"></div>

    <!-- üëÅ –í–∏–¥ -->
    <div class="panel">
      <div class="title" style="margin-bottom:6px;">–í–∏–¥</div>
      <div class="row">
        <button id="btnShowAll" class="ghost">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å—ë</button>
        <button id="btnHideAll" class="ghost">–°–∫—Ä—ã—Ç—å –≤—Å—ë</button>
        <button id="btnFit" class="ghost">–í–ø–∏—Å–∞—Ç—å –≤ —ç–∫—Ä–∞–Ω</button>
        <button id="btnPrint" class="ghost">–†–∞—Å–ø–µ—á–∞—Ç–∞—Ç—å</button>
      </div>
      <div class="hint" style="margin-top:6px;">–õ–µ–π–±–ª—ã –¥–æ–º–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –Ω–∞ –∑—É–º–µ ‚â• 15. –í —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ: Shift+—Ç–∞—â–∏—Ç—å ‚Äî –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ.</div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
(function(){
  const DEFAULT_BASE_COLOR = '#7c3aed';
  const LABEL_ZOOM_MIN = 15;
  const $ = id => document.getElementById(id);

  // --- –ö–∞—Ä—Ç–∞
  const map = L.map('map').setView([51.533, 46.033], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);

  // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ
  const state = {
    db: {version:1, updated_at:new Date().toISOString(), items:[]},
    features: new Map(),
    labels: [],
    selectedBaseId: null,
    baseCollapsed: false,
    cityFilter: new Set(),
    searchMode: 'local',
    searchQuery: '',
    searchMarker: null,
    baseVisibleIds: new Set(),

    orders: [],
    orderLayers: new Map(),
    addrToOrder: new Map(),
    activeOrderId: null,

    selection: new Set(),
    dragRect: null,
    dragStart: null,

    ghDb: null,
    ghNrd: null
  };

  // --- Helpers
  const esc = s => String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const norm = s => String(s||'').toLowerCase().replaceAll('—ë','–µ').trim();
  const ringLonLat_to_LatLng = ring => ring.map(([x,y])=>[y,x]);
  const ringLatLng_to_LonLat = ring => ring.map(p=>[p.lng, p.lat]);
  const rand = n => Math.floor(Math.random()*n);
  function extractHouse(t){
    const s=String(t||'').trim();
    const m=s.match(/,\s*([^,]+)\s*$/); if(m) return m[1].replace(/^(–¥–æ–º|–¥\.)\s*/i,'').trim();
    const m2=s.match(/(\d+[0-9A-Za-z–ê-–Ø–∞-—è–Å—ë\/\-]*?)\s*$/); return m2?m2[1]:s;
  }
  function uid(){ return (crypto?.randomUUID?.() || (Date.now().toString(36)+Math.random().toString(36).slice(2,8))); }
  function makeOrderCode(){
    const d=new Date(); const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0');
    return `NRD-${y}${m}${day}-${String(rand(9999)).padStart(4,'0')}`;
  }

  // --- GitHub helpers
  function parseGhFromHashKey(key, fallbackPath){
    const h = new URLSearchParams(location.hash.slice(1));
    const gh = h.get(key); const token = h.get('token');
    if(!gh || !token) return null;
    const [repoPart, bp] = gh.split('@');
    const [branch, ...pathParts] = (bp||`main:${fallbackPath}`).split(':');
    const path = pathParts.join(':') || fallbackPath;
    return { repo: repoPart, branch, path, token };
  }
  function encodePathForContentsAPI(path){ return path.split('/').map(encodeURIComponent).join('/'); }
  function toBase64Unicode(str){
    const bytes = new TextEncoder().encode(str);
    let bin = ''; const CHUNK = 0x8000;
    for (let i = 0; i < bytes.length; i += CHUNK) { bin += String.fromCharCode(...bytes.subarray(i, i + CHUNK)); }
    return btoa(bin);
  }
  async function ghGetSha({repo,branch,path,token}){
    const url = `https://api.github.com/repos/${repo}/contents/${encodePathForContentsAPI(path)}?ref=${encodeURIComponent(branch)}`;
    const r = await fetch(url, { method:'GET', headers:{ 'Authorization':`Bearer ${token}`, 'Accept':'application/vnd.github+json', 'X-GitHub-Api-Version':'2022-11-28' } });
    if(r.status===404) return null;
    if(!r.ok){ const t=await r.text().catch(()=> ''); throw new Error(`GitHub GET ${r.status}: ${t}`); }
    const j = await r.json(); return j.sha || null;
  }
  async function ghPut({repo,branch,path,token}, content, sha){
    const url = `https://api.github.com/repos/${repo}/contents/${encodePathForContentsAPI(path)}`;
    const body = { message:`update ${path} via leaflet`, branch, content: toBase64Unicode(content), ...(sha?{sha}:{}) };
    const r = await fetch(url, { method:'PUT', headers:{ 'Authorization':`Bearer ${token}`, 'Accept':'application/vnd.github+json', 'Content-Type':'application/json', 'X-GitHub-Api-Version':'2022-11-28' }, body: JSON.stringify(body) });
    if(!r.ok){ const txt=await r.text().catch(()=> ''); const err=new Error(`GitHub PUT ${r.status}: ${txt||'Failed to save'}`); err._status=r.status; throw err; }
    return await r.json();
  }

  // --- –ë–∞–∑–∞: —Å–ª–æ–∏ –∏ –≤–∏–¥–∏–º–æ—Å—Ç—å
  function ensureBaseLayer(it){
    let poly = state.features.get(it.id);
    if(!poly && Array.isArray(it.polygon) && it.polygon.length>=3){
      const ll = ringLonLat_to_LatLng(it.polygon);
      poly = L.polygon(ll, { color:DEFAULT_BASE_COLOR, weight:2, fillColor:DEFAULT_BASE_COLOR, fillOpacity:.85 });
      poly._id = it.id;
      poly.on('click',()=> onBasePolygonClick(it.id));
      state.features.set(it.id, poly);
    }
    return poly || null;
  }
  function placeEdgeLabel(layer, text){
    if(map.getZoom() < LABEL_ZOOM_MIN) return;
    const b=layer.getBounds();
    const pos = map.layerPointToLatLng(map.latLngToLayerPoint(L.latLng(b.getNorth(), (b.getEast()+b.getWest())/2)).add([0,-12]));
    const icon = L.divIcon({ className:'house-label', html:`<span class="hl">${esc(text||'')}</span>` });
    const mk = L.marker(pos, { icon, interactive:false }).addTo(map);
    state.labels.push(mk);
  }
  function addBaseLabelsIfZoom(){
    state.labels.forEach(m=>map.removeLayer(m)); state.labels=[];
    if(map.getZoom() < LABEL_ZOOM_MIN) return;
    state.features.forEach(l=>{
      if(map.hasLayer(l)){
        const it = state.db.items.find(x=>x.id===l._id);
        if(it) placeEdgeLabel(l, extractHouse(it.title));
      }
    });
  }
  function applyBaseVisibility(){
    state.labels.forEach(m=>map.removeLayer(m)); state.labels=[];
    state.db.items.forEach(it=>{
      const layer = state.features.get(it.id);
      const passCity = (state.cityFilter.size===0) || state.cityFilter.has((it.city||'').trim().toLowerCase());
      const passSearch = !state.searchQuery || norm(`${it.city} ${it.title}`).includes(norm(state.searchQuery));
      const passVisible = state.baseVisibleIds.has(it.id);
      const passNotCollapsed = !state.baseCollapsed;
      const passNotInOrders = !state.addrToOrder.has(it.id);
      const pass = passCity && passSearch && passVisible && passNotCollapsed && passNotInOrders && Array.isArray(it.polygon) && it.polygon.length>=3;
      if(pass){
        const poly = ensureBaseLayer(it);
        if(poly && !map.hasLayer(poly)) poly.addTo(map);
        if(poly) placeEdgeLabel(poly, extractHouse(it.title));
      } else {
        if(layer && map.hasLayer(layer)) map.removeLayer(layer);
      }
    });
  }
  function fitAllVisible(){
    const b=L.latLngBounds();
    state.features.forEach(l=>{ if(map.hasLayer(l)) b.extend(l.getBounds()); });
    state.orderLayers.forEach(g=>{ if(map.hasLayer(g)) b.extend(g.getBounds()); });
    if(b.isValid()) map.fitBounds(b.pad(0.15));
  }

  // --- –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã
  function normalizeDb(j){
    return {
      version: j.version||1,
      updated_at: j.updated_at || new Date().toISOString(),
      items: Array.isArray(j.items) ? j.items.map(x=>({
        id: String(x.id || uid()), title: x.title||'', city: x.city||'', polygon: Array.isArray(x.polygon)?x.polygon:null
      })) : []
    };
  }
  async function loadDbFromUrl(url){
    const bust = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
    const r = await fetch(bust, { cache:'no-store', headers:{'Accept':'application/json'} });
    if(!r.ok) throw new Error('HTTP '+r.status);
    state.db = normalizeDb(await r.json());
    state.baseVisibleIds = new Set(state.db.items.map(x=>x.id));
    renderCityChips();
    renderBaseList();
    applyBaseVisibility();
  }

  // --- –ü–æ–∏—Å–∫/—Ñ–∏–ª—å—Ç—Ä—ã
  const searchBox = $('searchBox');
  const tabLocal = $('tabLocal');
  const tabGlobal = $('tabGlobal');
  const suggestBox = $('suggestBox');
  const searchCount = $('searchCount');

  tabLocal.onclick = ()=>{ tabLocal.classList.add('active'); tabGlobal.classList.remove('active'); state.searchMode='local'; suggestBox.style.display='none'; setSearch(searchBox.value); };
  tabGlobal.onclick = ()=>{ tabGlobal.classList.add('active'); tabLocal.classList.remove('active'); state.searchMode='global'; setSearch(searchBox.value); };

  $('searchClear').onclick = ()=>{ searchBox.value=''; setSearch(''); searchBox.focus(); };
  searchBox.addEventListener('input', (e)=> setSearch(e.target.value));
  searchBox.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      const first = document.querySelector('#itemsList .item');
      if(first){ const id = first.dataset.id; focusBaseItem(id, {scroll:true}); }
    } else if(e.key==='Escape'){ $('searchClear').click(); }
  });
  window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); searchBox.focus(); searchBox.select(); }});
  function setSearch(v){ state.searchQuery=v; renderBaseList(); applyBaseVisibility(); if(state.searchMode==='global') debouncedNominatim(v); }

  // --- –°–ø–∏—Å–æ–∫ –±–∞–∑—ã
  function renderBaseList(){
    const host=$('itemsList'); host.innerHTML='';
    const filtered = state.db.items.filter(it =>
      (state.cityFilter.size===0 || state.cityFilter.has((it.city||'').trim().toLowerCase())) &&
      (!state.searchQuery || norm(`${it.city} ${it.title}`).includes(norm(state.searchQuery)))
    );
    $('countLbl').textContent = state.db.items.length;
    $('searchCount').textContent = `${filtered.length} —Å–æ–≤–ø–∞–¥.`;

    filtered.slice().sort((a,b)=> (a.city||'').localeCompare(b.city||'', 'ru') || (a.title||'').localeCompare(b.title||'', 'ru')).forEach(it=>{
      const div=document.createElement('div');
      div.className='item'+(state.selectedBaseId===it.id?' active':'');
      div.dataset.id=it.id;
      const checked = state.baseVisibleIds.has(it.id) ? 'checked' : '';
      const inOther = state.addrToOrder.has(it.id);
      div.innerHTML = `
        <label class="vis"><input type="checkbox" class="visToggle" ${checked} ${state.baseCollapsed?'disabled':''} /></label>
        <div>
          <div class="title">${esc(it.title||'(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)')}</div>
          <div class="muted">${it.city||'–ë–µ–∑ –≥–æ—Ä–æ–¥–∞'} ‚Ä¢ ${it.polygon&&it.polygon.length>=3?'–ö–æ–Ω—Ç—É—Ä –µ—Å—Ç—å':'–ö–æ–Ω—Ç—É—Ä –Ω–µ –∑–∞–¥–∞–Ω'} ${inOther? '‚Ä¢ <span class="dangerText">–≤ –Ω–∞—Ä—è–¥–µ</span>':''}</div>
        </div>
        <div class="act">
          <button class="ghost" title="–ü–æ–∫–∞–∑–∞—Ç—å">–ü–æ–∫–∞–∑–∞—Ç—å</button>
          <button class="ghost" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
          <button class="ghost" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
        </div>`;

      const visToggle = div.querySelector('.visToggle');
      visToggle.onchange = ()=>{ if(visToggle.checked) state.baseVisibleIds.add(it.id); else state.baseVisibleIds.delete(it.id); applyBaseVisibility(); };
      const [btnShow, btnEdit, btnDel] = div.querySelectorAll('.act button');
      btnShow.onclick = ()=>{ state.baseVisibleIds.add(it.id); applyBaseVisibility(); focusBaseItem(it.id, {scroll:true}); const cb=div.querySelector('.visToggle'); if(cb) cb.checked=true; };
      btnEdit.onclick = ()=> openBaseEditor(it.id);
      btnDel.onclick = ()=> deleteBaseItem(it.id);

      host.appendChild(div);
    });
  }
  function focusBaseItem(id,{scroll=true}={}){
    state.selectedBaseId=id; renderBaseList();
    const layer=state.features.get(id); if(layer && map.hasLayer(layer)) map.fitBounds(layer.getBounds().pad(0.3));
    if(scroll){ const el=document.querySelector(`#itemsList .item[data-id="${CSS.escape(id)}"]`); el && el.scrollIntoView({block:'center', behavior:'smooth'}); }
  }
  function onBasePolygonClick(id){ if(state.activeOrderId){ toggleAddrInActiveOrder(id); } else { focusBaseItem(id,{scroll:false}); } }

  // --- –ß–∏–ø—ã –≥–æ—Ä–æ–¥–æ–≤
  function uniqueCities(){ const set=new Set(); state.db.items.forEach(it=>{ const c=String(it.city||'').trim(); if(c) set.add(c); }); return Array.from(set).sort((a,b)=>a.localeCompare(b,'ru')); }
  function renderCityChips(){
    const host=$('cityChips'); host.innerHTML='';
    const all=document.createElement('span'); all.className='chip'+(state.cityFilter.size===0?' active':''); all.textContent='–í—Å–µ'; all.onclick=()=>{ state.cityFilter.clear(); renderBaseList(); applyBaseVisibility(); }; host.appendChild(all);
    uniqueCities().forEach(city=>{ const key=city.trim().toLowerCase(); const chip=document.createElement('span'); chip.className='chip'+(state.cityFilter.has(key)?' active':''); chip.textContent=city; chip.onclick=()=>{ if(state.cityFilter.has(key)) state.cityFilter.delete(key); else state.cityFilter.add(key); renderBaseList(); applyBaseVisibility(); }; host.appendChild(chip); });
  }

  // --- –°–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞—Å–∫—Ä—ã—Ç—å –±–∞–∑—É + –î–æ–±–∞–≤–∏—Ç—å
  $('btnToggleBase').onclick = ()=>{ state.baseCollapsed=!state.baseCollapsed; $('btnToggleBase').textContent = state.baseCollapsed? '–ü–æ–∫–∞–∑–∞—Ç—å –∞–¥—Ä–µ—Å–∞ –±–∞–∑—ã' : '–°–≤–µ—Ä–Ω—É—Ç—å –∞–¥—Ä–µ—Å–∞ –±–∞–∑—ã'; applyBaseVisibility(); renderBaseList(); };
  $('btnAddBase').onclick = ()=>{
    const id = uid(); const it = { id, title:'–ù–æ–≤—ã–π –∞–¥—Ä–µ—Å', city:'', polygon:null };
    state.db.items.push(it); state.baseVisibleIds.add(id); state.selectedBaseId=id; openBaseEditor(id);
  };

  // --- –ò–Ω–ª–∞–π–Ω-—Ä–µ–¥–∞–∫—Ç–æ—Ä –±–∞–∑—ã (relink/draw)
  function openBaseEditor(id){
    const it = state.db.items.find(x=>x.id===id); if(!it) return;
    const host = $('editPanel'); host.style.display=''; host.innerHTML='';
    if(host._cleanup) try{ host._cleanup(); }catch(_){}
    const div=document.createElement('div');
    div.innerHTML = `
      <div class="title" style="margin-bottom:6px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞</div>
      <div class="inline-row">
        <div>
          <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
          <input id="eTitle" type="text" value="${esc(it.title||'')}" />
        </div>
        <div>
          <div class="label">–ì–æ—Ä–æ–¥</div>
          <input id="eCity" type="text" value="${esc(it.city||'')}" />
        </div>
      </div>
      <div class="inline-actions" style="margin-top:6px;">
        <button id="btnRelink" class="ghost">–ü—Ä–∏–≤—è–∑–∞—Ç—å –∫ OSM</button>
        <button id="btnDraw" class="ghost">–ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é</button>
        <button id="btnDrawFinish" class="ghost" style="display:none;">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ</button>
        <button id="btnDrawUndo" class="ghost" style="display:none;">–û—Ç–º–µ–Ω–∏—Ç—å —Ç–æ—á–∫—É</button>
        <button id="btnClearPoly" class="ghost">–£–¥–∞–ª–∏—Ç—å –ø–æ–ª–∏–≥–æ–Ω</button>
      </div>
      <div class="inline-footer">
        <button id="btnSaveBase" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="btnCancelBase" class="ghost">–û—Ç–º–µ–Ω–∞</button>
        <span id="editMsg" class="muted"></span>
      </div>
      <div id="modeHint" class="hint" style="margin-top:6px;"></div>
    `;
    host.appendChild(div);

    const eTitle=$('eTitle'), eCity=$('eCity'), modeHint=$('modeHint');
    const btnRelink=$('btnRelink'), btnDraw=$('btnDraw'), btnDrawFinish=$('btnDrawFinish'), btnDrawUndo=$('btnDrawUndo'), btnClearPoly=$('btnClearPoly');

    state.selectedBaseId=id;
    let drawMode=false, drawPoints=[], drawLayer=null, previewLayer=null, relinkMode=false;

    function stopRelink(){ relinkMode=false; if(previewLayer){ map.removeLayer(previewLayer); previewLayer=null; } }
    function startDraw(){ drawMode=true; drawPoints=[]; if(drawLayer){ map.removeLayer(drawLayer); drawLayer=null; } btnDrawFinish.style.display=''; btnDrawUndo.style.display=''; modeHint.textContent='–ö–ª–∏–∫–∞–π –ø–æ –∫–∞—Ä—Ç–µ, —Å—Ç–∞–≤—å —Ç–æ—á–∫–∏. ¬´–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∏—Å–æ–≤–∞–Ω–∏–µ¬ª ‚Äî —á—Ç–æ–±—ã —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–∏–≥–æ–Ω.'; }
    function stopDraw(clear){
      drawMode=false; btnDrawFinish.style.display='none'; btnDrawUndo.style.display='none'; if(clear){ drawPoints=[]; if(drawLayer){ map.removeLayer(drawLayer); drawLayer=null; } }
    }

    btnRelink.onclick = ()=>{ stopDraw(true); relinkMode=true; modeHint.textContent='–ö–ª–∏–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç–µ —Ä—è–¥–æ–º —Å–æ –∑–¥–∞–Ω–∏–µ–º ‚Äî –Ω–∞–π–¥—ë–º –±–ª–∏–∂–∞–π—à–∏–π –∫–æ–Ω—Ç—É—Ä (OSM).'; };
    btnDraw.onclick = ()=>{ stopRelink(); startDraw(); };
    btnDrawFinish.onclick = ()=>{
      if(drawPoints.length<3) return alert('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —Ç–æ—á–∫–∏.');
      if(previewLayer) { map.removeLayer(previewLayer); previewLayer=null; }
      previewLayer = L.polygon(drawPoints, { color:'#111', weight:2, fillColor:DEFAULT_BASE_COLOR, fillOpacity:.5 }).addTo(map);
      stopDraw(false); modeHint.textContent='–ö–æ–Ω—Ç—É—Ä –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω. –ù–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.';
    };
    btnDrawUndo.onclick = ()=>{ drawPoints.pop(); if(drawLayer){ map.removeLayer(drawLayer); drawLayer=null; } if(drawPoints.length){ const pts=drawPoints.slice(); if(pts.length>=3) pts.push(pts[0]); drawLayer=L.polyline(pts,{color:'#111',weight:2}).addTo(map); } };
    btnClearPoly.onclick = ()=>{ it.polygon=null; state.db.updated_at=new Date().toISOString(); applyBaseVisibility(); renderBaseList(); $('editMsg').textContent='–ü–æ–ª–∏–≥–æ–Ω —É–¥–∞–ª—ë–Ω (–ª–æ–∫–∞–ª—å–Ω–æ).'; };

    $('btnSaveBase').onclick = async ()=>{
      it.title = eTitle.value.trim(); it.city = eCity.value.trim();
      if(previewLayer){ const ring = previewLayer.getLatLngs()[0]; it.polygon = ringLatLng_to_LonLat(ring); }
      state.db.updated_at = new Date().toISOString();
      try{ const res = await saveDb(); $('editMsg').className='muted ok'; $('editMsg').textContent = res; $('editPanel').style.display='none'; renderBaseList(); applyBaseVisibility(); }
      catch(err){ $('editMsg').className='muted dangerText'; $('editMsg').textContent = err.message; }
    };
    $('btnCancelBase').onclick = ()=>{ $('editPanel').style.display='none'; };

    function mapClick(e){
      if(drawMode){
        drawPoints.push(e.latlng);
        if(drawLayer){ map.removeLayer(drawLayer); drawLayer=null; }
        const pts=drawPoints.slice(); if(pts.length>=3) pts.push(pts[0]);
        drawLayer=L.polyline(pts,{color:'#111',weight:2}).addTo(map);
        return;
      }
      if(relinkMode){
        modeHint.textContent='–ò—â—É –±–ª–∏–∂–∞–π—à–∏–π –∫–æ–Ω—Ç—É—Ä‚Ä¶';
        fetchOverpassPolygon({lon:e.latlng.lng,lat:e.latlng.lat}, 500).then(ring=>{
          if(!ring){ modeHint.textContent='–ù–µ –Ω–∞—à—ë–ª –∫–æ–Ω—Ç—É—Ä. –ö–ª–∏–∫–Ω–∏ –±–ª–∏–∂–µ –∏ –ø–æ–≤—Ç–æ—Ä–∏.'; return; }
          if(previewLayer){ map.removeLayer(previewLayer); previewLayer=null; }
          previewLayer = L.polygon(ringLonLat_to_LatLng(ring), { color:'#111', weight:2, fillColor:DEFAULT_BASE_COLOR, fillOpacity:.5 }).addTo(map);
          map.fitBounds(previewLayer.getBounds().pad(0.2));
          modeHint.textContent='–ö–æ–Ω—Ç—É—Ä –Ω–∞–π–¥–µ–Ω. –ù–∞–∂–º–∏ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.';
        });
      }
    }
    function mapDbl(){ if(drawMode){ stopDraw(true); modeHint.textContent='–†–∏—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.'; } }
    map.on('click', mapClick); map.on('dblclick', mapDbl);
    host._cleanup = ()=>{ map.off('click', mapClick); map.off('dblclick', mapDbl); };
  }
  function deleteBaseItem(id){
    const it = state.db.items.find(x=>x.id===id); if(!it) return;
    if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∞–¥—Ä–µ—Å:\n\n${it.title || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)'}?`)) return;
    const layer = state.features.get(id); if(layer && map.hasLayer(layer)) map.removeLayer(layer);
    state.features.delete(id); state.baseVisibleIds.delete(id);
    state.db.items = state.db.items.filter(x=>x.id!==id);
    state.db.updated_at=new Date().toISOString();
    saveDb().then(msg=>{ $('loadMsg').textContent=`–£–¥–∞–ª–µ–Ω–æ. ${msg}`; $('loadMsg').className='muted ok'; renderBaseList(); applyBaseVisibility(); })
             .catch(err=>{ $('loadMsg').textContent=`–£–¥–∞–ª–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ. –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${err.message}`; $('loadMsg').className='muted dangerText'; renderBaseList(); applyBaseVisibility(); });
  }

  // --- Nominatim (OSM)
  let nomiTimer=null;
  async function nominatim(q){
    if(!q || q.trim().length<3){ suggestBox.style.display='none'; suggestBox.innerHTML=''; return; }
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('q', q); url.searchParams.set('format','jsonv2'); url.searchParams.set('limit','8'); url.searchParams.set('addressdetails','1'); url.searchParams.set('accept-language','ru');
    const r = await fetch(url.toString(), { headers:{'Accept':'application/json'} }); if(!r.ok) return;
    const arr = await r.json(); suggestBox.style.display=''; suggestBox.innerHTML = ''; searchCount.textContent = `${arr.length} –≤ OSM`;
    arr.forEach((it)=>{
      const city = it.address?.city || it.address?.town || it.address?.village || it.address?.municipality || '';
      const road = it.address?.road || it.address?.pedestrian || it.address?.footway || '';
      const house = it.address?.house_number || '';
      const title = ['–≥. '+city, road && ('—É–ª. '+road), house].filter(Boolean).join(', ');
      const div = document.createElement('div'); div.className='sg-item';
      div.innerHTML = `
        <div class="sg-top">
          <div class="sg-title">${esc(title || it.display_name)}</div>
          <button class="ghost sg-zoom">–ü–æ–∫–∞–∑–∞—Ç—å</button>
        </div>
        <div class="muted" style="margin-top:4px;">${esc(it.display_name)}</div>
        <div class="row" style="margin-top:6px;">
          <button class="primary sg-add">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ –Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å</button>
        </div>`;
      const btnZoom = div.querySelector('.sg-zoom'); const btnAdd  = div.querySelector('.sg-add');
      btnZoom.onclick = ()=> zoomToSuggestion(it);
      btnAdd.onclick  = ()=> addFromSuggestion(it);
      suggestBox.appendChild(div);
    });
  }
  function debouncedNominatim(q){ clearTimeout(nomiTimer); nomiTimer = setTimeout(()=>nominatim(q), 250); }
  function zoomToSuggestion(sg){ const lat=+sg.lat, lon=+sg.lon; if(state.searchMarker){ map.removeLayer(state.searchMarker); state.searchMarker=null; } state.searchMarker = L.marker([lat,lon]).addTo(map).bindPopup(esc(sg.display_name)+'<br/><button id="ppAddBtn">–î–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ –Ω–æ–≤—ã–π</button>').openPopup(); map.setView([lat,lon], 18); setTimeout(()=>{ const btn = document.getElementById('ppAddBtn'); if(btn) btn.onclick = ()=> addFromSuggestion(sg); }, 0); }
  async function addFromSuggestion(sg){
    const city = sg.address?.city || sg.address?.town || sg.address?.village || sg.address?.municipality || '';
    const road = sg.address?.road || sg.address?.pedestrian || sg.address?.footway || '';
    const house = sg.address?.house_number || '';
    const title = ['–≥. '+(city||'').trim(), road && ('—É–ª. '+road), house].filter(Boolean).join(', ').replace(/\s+,/g,',');
    const id = uid(); const it = { id, title: title || sg.display_name, city: city || '', polygon: null };
    state.db.items.push(it); state.baseVisibleIds.add(id); state.selectedBaseId = id;
    try{ const ring = await fetchOverpassPolygon({lon:+sg.lon, lat:+sg.lat}, 400); if(ring){ it.polygon = ring; } }catch(_){ }
    renderBaseList(); applyBaseVisibility(); const row = document.querySelector(`#itemsList .item[data-id="${CSS.escape(id)}"]`); row && row.scrollIntoView({block:'center', behavior:'smooth'});
  }

  // --- Overpass helper
  async function fetchOverpassPolygon({ lon, lat }, radius = 500){
    const EPS=['https://overpass.kumi.systems/api/interpreter','https://overpass-api.de/api/interpreter','https://overpass.openstreetmap.ru/api/interpreter'];
    const q=`[out:json][timeout:60];(way["building"](around:${radius},${lat},${lon});relation["building"](around:${radius},${lat},${lon}););out body geom;`;
    for(const ep of EPS){
      try{ const r=await fetch(ep,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},body:new URLSearchParams({data:q})}); if(!r.ok) continue; const j=await r.json(); const a=j.elements||[]; if(!a.length) continue; let best=null, bestD=Infinity; for(const el of a){ const g=el.geometry; if(!Array.isArray(g)||g.length<4) continue; const ring=g.map(p=>[p.lon,p.lat]); let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity; ring.forEach(([x,y])=>{ if(x<minX)minX=x; if(x>maxX)maxX=x; if(y<minY)minY=y; if(y>maxY)maxY=y; }); const cx=(minX+maxX)/2, cy=(minY+maxY)/2; const d=(cx-lon)*(cx-lon)+(cy-lat)*(cy-lat); if(d<bestD){bestD=d;best=ring;} } if(best){ const f=best[0], l=best[best.length-1]; if(f[0]!==l[0]||f[1]!==l[1]) best.push([f[0],f[1]]); return best; } }catch(e){ /* try next */ }
    }
    return null;
  }

/* ====== –ß–ê–°–¢–¨ 1 –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å. –í—Å—Ç–∞–≤—å –ß–ê–°–¢–¨ 2 —Å—Ä–∞–∑—É –Ω–∏–∂–µ, –Ω–∏—á–µ–≥–æ –Ω–µ —É–¥–∞–ª—è—è. –°–∫—Ä–∏–ø—Ç –∏ IIFE –µ—â—ë –ù–ï –∑–∞–∫—Ä—ã—Ç—ã. ====== */
  // =========================
  // ===== –ù –ê –† –Ø –î –´ ======
  // =========================

  // –°–ª–æ–∏ –∏ —Ä–µ–Ω–¥–µ—Ä
  function ensureOrderLayer(order){
    let group = state.orderLayers.get(order.id);
    if(!group){
      group = L.featureGroup();
      group._orderId = order.id;
      group.addTo(map);
      state.orderLayers.set(order.id, group);
    }
    return group;
  }
  function refreshOrderLayer(order){
    const group = ensureOrderLayer(order);
    group.clearLayers();
    order.items.forEach(({id})=>{
      const it = state.db.items.find(x=>x.id===id);
      if(!it || !Array.isArray(it.polygon) || it.polygon.length<3) return;
      const poly = L.polygon(ringLonLat_to_LatLng(it.polygon), {
        color:order.color, weight:2, fillColor:order.color, fillOpacity:.9
      });
      poly.on('click',()=>{ if(state.activeOrderId===order.id) toggleAddrInActiveOrder(id); });
      poly.bindTooltip(`${esc(it.title)}<br>–ö–æ–ª: ${order.items.find(x=>x.id===id)?.qty||0}`, {sticky:true});
      group.addLayer(poly);
    });
  }
  function renderOrdersList(){
    const host = $('ordersList');
    host.innerHTML = '';
    if(!state.orders.length){
      host.innerHTML = '<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∞—Ä—è–¥–æ–≤.</div>';
      return;
    }
    state.orders
      .slice()
      .sort((a,b)=> (b.created_at||'').localeCompare(a.created_at||''))
      .forEach(order=>{
        const total = order.items.reduce((s,x)=> s + (Number(x.qty)||0), 0);
        const div=document.createElement('div');
        div.className='item'+(state.activeOrderId===order.id?' active':'');
        div.dataset.id=order.id;
        const vis = map.hasLayer(ensureOrderLayer(order)) ? 'checked' : '';
        div.innerHTML = `
          <label class="vis"><input type="checkbox" class="visOrder" ${vis} /></label>
          <div>
            <div class="title">${esc(order.company)} ‚Ä¢ <span style="color:${order.color}">‚óè</span> ${order.code}</div>
            <div class="muted">–ê–¥—Ä–µ—Å–æ–≤: ${order.items.length} ‚Ä¢ –ö–æ–ª –≤—Å–µ–≥–æ: ${total}</div>
          </div>
          <div class="act">
            <button class="ghost btnEdit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="ghost btnFit">–ü–æ–∫–∞–∑–∞—Ç—å</button>
            <button class="danger btnDel">–£–¥–∞–ª–∏—Ç—å</button>
          </div>`;
        div.querySelector('.visOrder').onchange = (e)=>{
          const g=ensureOrderLayer(order);
          if(e.target.checked){ g.addTo(map); } else { map.removeLayer(g); }
        };
        div.querySelector('.btnFit').onclick = ()=>{
          const g=ensureOrderLayer(order);
          if(g && g.getBounds && g.getLayers().length){ map.fitBounds(g.getBounds().pad(0.2)); }
          addBaseLabelsIfZoom();
        };
        div.querySelector('.btnEdit').onclick = ()=> openOrderEditor(order.id);
        div.querySelector('.btnDel').onclick = ()=> deleteOrder(order.id);
        host.appendChild(div);
      });
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ XLSX/CSV (–∫–Ω–æ–ø–∫–∏ –≤ —Ä–∞–∑–º–µ—Ç–∫–µ —É–∂–µ –µ—Å—Ç—å)
  const fileInput=$('fileInput'),
        btnClearUpload=$('btnClearUpload'),
        uploadStats=$('uploadStats'),
        matchTableWrap=$('matchTableWrap'),
        matchTable=$('matchTable'),
        companyInput=$('companyInput'),
        colorInput=$('colorInput'),
        btnCreateOrder=$('btnCreateOrder');

  let uploadRows=[]; // [{address, qty, foundId|null}]

  fileInput.addEventListener('change', handleFile);
  btnClearUpload.onclick = ()=>{
    fileInput.value=''; uploadRows=[]; uploadStats.textContent='';
    matchTableWrap.style.display='none'; matchTable.innerHTML='';
  };

  async function handleFile(){
    const file = fileInput.files?.[0]; if(!file) return;
    const buf = await file.arrayBuffer(); let rows = [];
    if(/\.csv$/i.test(file.name)){
      const txt = new TextDecoder('utf-8').decode(new Uint8Array(buf));
      rows = parseCSV(txt);
    } else {
      const wb = XLSX.read(buf, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      rows = XLSX.utils.sheet_to_json(ws, {defval:''});
    }
    const mapped = rows.map(r=>({
      address: String(r['–ê–¥—Ä–µ—Å'] ?? r['–∞–¥—Ä–µ—Å'] ?? r['Address'] ?? '').trim(),
      qty: Number(r['–ö–æ–ª'] ?? r['–∫–æ–ª'] ?? r['–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'] ?? 0) || 0
    })).filter(x=>x.address);

    const baseByTitle = new Map(state.db.items.map(it=> [norm(it.title), it.id] ));
    uploadRows = mapped.map(r=>({ address:r.address, qty:r.qty, foundId: baseByTitle.get(norm(r.address)) || null }));

    const hits = uploadRows.filter(x=>x.foundId);
    const miss = uploadRows.filter(x=>!x.foundId);
    uploadStats.innerHTML = `–í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: <b>${uploadRows.length}</b> ‚Ä¢ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ: <b>${hits.length}</b> ‚Ä¢ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã: <b>${miss.length}</b>`;
    renderMatchTable();
  }

  function parseCSV(txt){
    const sep = txt.includes(';') && !txt.includes(',') ? ';' : ',';
    const lines = txt.split(/\r?\n/).filter(Boolean);
    const header = lines[0].split(sep).map(s=>s.trim());
    const idxA = header.findIndex(h=> /^(–ê–¥—Ä–µ—Å|Address)$/i.test(h));
    const idxQ = header.findIndex(h=> /^(–ö–æ–ª|–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ)$/i.test(h));
    const arr = [];
    for(let i=1;i<lines.length;i++){
      const cells=lines[i].split(sep);
      arr.push({ '–ê–¥—Ä–µ—Å': cells[idxA]||'', '–ö–æ–ª': cells[idxQ]||0 });
    }
    return arr;
  }

  function renderMatchTable(){
    matchTableWrap.style.display='';
    matchTable.innerHTML = '';
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr><th>#</th><th>–ê–¥—Ä–µ—Å</th><th>–ö–æ–ª</th><th>–°—Ç–∞—Ç—É—Å</th></tr>';
    matchTable.appendChild(thead);
    const tbody = document.createElement('tbody');
    uploadRows.forEach((r,i)=>{
      const tr=document.createElement('tr');
      tr.className = r.foundId? 'hit' : 'miss';
      tr.innerHTML = `<td>${i+1}</td><td>${esc(r.address)}</td><td>${r.qty}</td><td>${r.foundId? '–ù–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ' : '–ù–µ –Ω–∞–π–¥–µ–Ω'}</td>`;
      tbody.appendChild(tr);
    });
    matchTable.appendChild(tbody);
  }

  // –°–æ–∑–¥–∞—Ç—å –Ω–∞—Ä—è–¥ –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤
  btnCreateOrder.onclick = ()=>{
    const hits = uploadRows.filter(x=>x.foundId);
    if(!hits.length) return alert('–ù–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤, –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—á–µ–≥–æ.');

    const company = companyInput.value.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
    const color = colorInput.value || '#e11d48';

    const items=[]; const skipped=[];
    hits.forEach(h=>{
      if(state.addrToOrder.has(h.foundId)) skipped.push(h.address);
      else items.push({id:h.foundId, qty: Number(h.qty)||0});
    });
    if(!items.length) return alert('–í—Å–µ –∞–¥—Ä–µ—Å–∞ –∏–∑ —Ñ–∞–π–ª–∞ —É–∂–µ –µ—Å—Ç—å –≤ –¥—Ä—É–≥–∏—Ö –Ω–∞—Ä—è–¥–∞—Ö.');

    const order={ id: uid(), code: makeOrderCode(), company, color, items, created_at: new Date().toISOString() };
    state.orders.push(order);
    items.forEach(it=> state.addrToOrder.set(it.id, order.id));
    refreshOrderLayer(order);
    renderOrdersList();
    // —Å–∫—Ä—ã–≤–∞–µ–º –∏—Ö –∏–∑ —Å–ª–æ—è –±–∞–∑—ã
    items.forEach(it=> state.baseVisibleIds.delete(it.id));
    applyBaseVisibility();
    openOrderEditor(order.id);
    if(skipped.length) alert('–ü—Ä–æ–ø—É—â–µ–Ω—ã –∞–¥—Ä–µ—Å–∞, —É–∂–µ –≤ –¥—Ä—É–≥–∏—Ö –Ω–∞—Ä—è–¥–∞—Ö:\n\n'+skipped.join('\n'));
    saveNaryads(true).catch(()=>{});
  };

  // –†–µ–¥–∞–∫—Ç–æ—Ä –Ω–∞—Ä—è–¥–∞
  function openOrderEditor(orderId){
    state.activeOrderId = orderId;
    const order = state.orders.find(x=>x.id===orderId); if(!order) return;
    const host = $('orderEditPanel'); host.style.display=''; host.innerHTML = '';

    const div=document.createElement('div');
    div.innerHTML = `
      <div class="title" style="margin-bottom:6px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${esc(order.company)} ‚Ä¢ <span style="color:${order.color}">‚óè</span> ${order.code}</div>
      <div class="row" style="margin-bottom:8px;">
        <input id="eCompany" type="text" value="${esc(order.company)}" />
        <input id="eColor" type="color" value="${order.color}" />
        <button id="eSave" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="eClose" class="ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="hint">–ö–ª–∏–∫–∞–π –ø–æ –¥–æ–º–∞–º –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å –∏—Ö –∏–∑ –Ω–∞—Ä—è–¥–∞. –õ–∏–±–æ Shift+–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–º. –î–æ–º–∞, –ø–æ–ø–∞–≤—à–∏–µ –≤ –Ω–∞—Ä—è–¥, —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –≤ —Å–ª–æ–µ –±–∞–∑—ã.</div>
      <div class="row" style="margin-top:8px;">
        <button id="eSelectAllInView" class="ghost">–î–æ–±–∞–≤–∏—Ç—å –¥–æ–º–∞ –≤ –∫–∞–¥—Ä–µ</button>
        <button id="eClearSelection" class="ghost">–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ</button>
        <button id="eExportXlsx" class="ghost">–≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü—ã (XLSX)</button>
      </div>
      <div style="max-height:220px; overflow:auto; margin-top:8px;">
        <table id="orderTable"></table>
      </div>`;
    host.appendChild(div);

    div.querySelector('#eSave').onclick = ()=>{
      order.company = div.querySelector('#eCompany').value.trim()||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      order.color = div.querySelector('#eColor').value||order.color;
      refreshOrderLayer(order); renderOrdersList(); saveNaryads(true).catch(()=>{});
    };
    div.querySelector('#eClose').onclick = ()=>{ state.activeOrderId=null; host.style.display='none'; };
    div.querySelector('#eSelectAllInView').onclick = ()=> selectAllBaseInViewIntoOrder(order);
    div.querySelector('#eClearSelection').onclick = ()=>{ state.selection.clear(); };
    div.querySelector('#eExportXlsx').onclick = ()=> exportOrderXlsx(order);

    renderOrderTable(order);
    ensureOrderLayer(order).addTo(map);
    const g=ensureOrderLayer(order);
    if(g.getLayers().length) map.fitBounds(g.getBounds().pad(0.2));
  }

  function renderOrderTable(order){
    const t=$('orderTable'); t.innerHTML='';
    const thead=document.createElement('thead');
    thead.innerHTML='<tr><th>#</th><th>–ê–¥—Ä–µ—Å</th><th>–ö–æ–ª</th><th></th></tr>';
    t.appendChild(thead);
    const tbody=document.createElement('tbody');
    order.items.forEach((it,i)=>{
      const base=state.db.items.find(x=>x.id===it.id); if(!base) return;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${i+1}</td><td>${esc(base.title)}</td><td><input type="number" class="qty" min="0" value="${Number(it.qty)||0}" style="width:80px"></td><td><button class="ghost btnRemove">–£–±—Ä–∞—Ç—å</button></td>`;
      tr.querySelector('.qty').onchange = (e)=>{
        it.qty = Number(e.target.value)||0;
        refreshOrderLayer(order); renderOrdersList(); saveNaryads(true).catch(()=>{});
      };
      tr.querySelector('.btnRemove').onclick = ()=>{
        removeAddrFromOrder(order.id, it.id); saveNaryads(true).catch(()=>{});
      };
      tbody.appendChild(tr);
    });
    t.appendChild(tbody);
  }

  function toggleAddrInActiveOrder(addrId){
    const order = state.orders.find(x=>x.id===state.activeOrderId); if(!order) return;
    if(state.addrToOrder.has(addrId) && state.addrToOrder.get(addrId)!==order.id){
      return alert('–ê–¥—Ä–µ—Å —É–∂–µ –≤ –¥—Ä—É–≥–æ–º –Ω–∞—Ä—è–¥–µ.');
    }
    const idx = order.items.findIndex(x=>x.id===addrId);
    if(idx===-1){
      order.items.push({id:addrId, qty:0});
      state.addrToOrder.set(addrId, order.id);
      state.baseVisibleIds.delete(addrId);
    } else {
      order.items.splice(idx,1);
      state.addrToOrder.delete(addrId);
      state.baseVisibleIds.add(addrId);
    }
    refreshOrderLayer(order); renderOrdersList(); renderOrderTable(order); applyBaseVisibility(); saveNaryads(true).catch(()=>{});
  }

  function removeAddrFromOrder(orderId, addrId){
    const order=state.orders.find(x=>x.id===orderId); if(!order) return;
    const idx=order.items.findIndex(x=>x.id===addrId);
    if(idx!==-1){ order.items.splice(idx,1); }
    state.addrToOrder.delete(addrId);
    state.baseVisibleIds.add(addrId);
    refreshOrderLayer(order); renderOrdersList(); renderOrderTable(order); applyBaseVisibility();
  }

  function selectAllBaseInViewIntoOrder(order){
    const inView=[];
    state.db.items.forEach(it=>{
      if(!Array.isArray(it.polygon)||it.polygon.length<3) return;
      const layer=ensureBaseLayer(it); if(!layer) return;
      if(map.getBounds().intersects(layer.getBounds())) inView.push(it.id);
    });
    inView.forEach(id=>{
      if(!state.addrToOrder.has(id)){
        order.items.push({id, qty:0});
        state.addrToOrder.set(id, order.id);
        state.baseVisibleIds.delete(id);
      }
    });
    refreshOrderLayer(order); renderOrdersList(); renderOrderTable(order); applyBaseVisibility(); saveNaryads(true).catch(()=>{});
  }

  // –°–æ–∑–¥–∞–Ω–∏–µ –ø—É—Å—Ç–æ–≥–æ –Ω–∞—Ä—è–¥–∞ –≤—Ä—É—á–Ω—É—é
  $('btnAddManual').onclick = ()=>{
    const order={ id:uid(), code:makeOrderCode(), company:'–ù–æ–≤—ã–π –∑–∞–∫–∞–∑—á–∏–∫', color:'#0ea5e9', items:[], created_at:new Date().toISOString() };
    state.orders.push(order);
    refreshOrderLayer(order); renderOrdersList(); openOrderEditor(order.id); saveNaryads(true).catch(()=>{});
  };

  function deleteOrder(orderId){
    const order=state.orders.find(x=>x.id===orderId); if(!order) return;
    if(!confirm(`–£–¥–∞–ª–∏—Ç—å –Ω–∞—Ä—è–¥ ${order.code} (${order.company})?`)) return;
    order.items.forEach(it=>{ state.addrToOrder.delete(it.id); state.baseVisibleIds.add(it.id); });
    const g=state.orderLayers.get(orderId); if(g) map.removeLayer(g);
    state.orderLayers.delete(orderId);
    state.orders = state.orders.filter(x=>x.id!==orderId);
    if(state.activeOrderId===orderId){ state.activeOrderId=null; $('orderEditPanel').style.display='none'; }
    renderOrdersList(); applyBaseVisibility(); saveNaryads(true).catch(()=>{});
  }

  // –ü–µ—á–∞—Ç—å + —ç–∫—Å–ø–æ—Ä—Ç XLSX
  $('btnPrint').onclick = ()=>{
    const orderId = state.activeOrderId || (state.orders[0]?.id);
    if(!orderId) return window.print();
    const order = state.orders.find(x=>x.id===orderId); if(!order) return;
    const g=ensureOrderLayer(order);
    if(g && g.getLayers().length){ map.fitBounds(g.getBounds().pad(0.1)); }
    const rows = order.items.map(it=>{
      const base=state.db.items.find(x=>x.id===it.id);
      return { '–ö–æ–º–ø–∞–Ω–∏—è': order.company, '–¶–≤–µ—Ç': order.color, '–ê–¥—Ä–µ—Å': base? base.title : it.id, '–ö–æ–ª': Number(it.qty)||0, '–ö–æ–¥ –∫–∞—Ä—Ç—ã': order.code, '–ö–æ–¥ –Ω–∞—Ä—è–¥–∞': order.code };
    });
    const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ü–µ—á–∞—Ç—å ${esc(order.code)}</title><style>body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:16px;}h1{margin:0 0 12px;}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;padding:6px 8px;text-align:left;font-size:12px}</style></head><body><h1>–ù–∞—Ä—è–¥ ${esc(order.code)} ‚Äî ${esc(order.company)} <span style="color:${order.color}">‚óè</span></h1><p>–î–∞—Ç–∞: ${new Date(order.created_at).toLocaleString()}</p><table><thead><tr><th>#</th><th>–ö–æ–º–ø–∞–Ω–∏—è</th><th>–¶–≤–µ—Ç</th><th>–ê–¥—Ä–µ—Å</th><th>–ö–æ–ª</th><th>–ö–æ–¥ –Ω–∞—Ä—è–¥–∞</th></tr></thead><tbody>${rows.map((r,i)=>`<tr><td>${i+1}</td><td>${esc(r['–ö–æ–º–ø–∞–Ω–∏—è'])}</td><td><span style="color:${r['–¶–≤–µ—Ç']}">‚óè</span> ${esc(r['–¶–≤–µ—Ç'])}</td><td>${esc(r['–ê–¥—Ä–µ—Å'])}</td><td>${r['–ö–æ–ª']}</td><td>${esc(r['–ö–æ–¥ –Ω–∞—Ä—è–¥–∞'])}</td></tr>`).join('')}</tbody></table><script>window.onload=()=>window.print();<\/script></body></html>`;
    const w=window.open('about:blank','_blank'); w.document.write(html); w.document.close();
  };
  function exportOrderXlsx(order){
    const data = order.items.map(it=>{
      const base=state.db.items.find(x=>x.id===it.id);
      return { '–ê–¥—Ä–µ—Å': base? base.title : it.id, '–ö–æ–º–ø–∞–Ω–∏—è': order.company, '–¶–≤–µ—Ç': order.color, '–ö–æ–ª': Number(it.qty)||0, '–ö–æ–¥ –∫–∞—Ä—Ç—ã': order.code, '–ö–æ–¥ –Ω–∞—Ä—è–¥–∞': order.code };
    });
    const ws = XLSX.utils.json_to_sheet(data, { header:['–ö–æ–º–ø–∞–Ω–∏—è','–¶–≤–µ—Ç','–ê–¥—Ä–µ—Å','–ö–æ–ª','–ö–æ–¥ –∫–∞—Ä—Ç—ã','–ö–æ–¥ –Ω–∞—Ä—è–¥–∞'] });
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, '–ù–∞—Ä—è–¥');
    const fn = `naryad_${order.code}.xlsx`; XLSX.writeFile(wb, fn);
  }

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ naryad.json
  $('btnSaveNaryad').onclick = ()=> saveNaryads();
  $('btnLoadNaryad').onclick = ()=> $('naryadLoad').click();
  $('naryadLoad').addEventListener('change', async (e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const txt=await f.text();
    try{ const j=JSON.parse(txt); loadNaryadsFromObject(j); alert('–ù–∞—Ä—è–¥—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã.'); }
    catch(err){ alert('–û—à–∏–±–∫–∞ JSON: '+err.message); }
  });

  function getNaryadsObject(){ return { version:1, updated_at: new Date().toISOString(), orders: state.orders }; }
  function loadNaryadsFromObject(obj){
    state.orders = Array.isArray(obj.orders)? obj.orders : [];
    state.addrToOrder.clear();
    state.orders.forEach(o=> o.items.forEach(it=> state.addrToOrder.set(it.id, o.id)) );
    state.orderLayers.forEach(g=> map.removeLayer(g)); state.orderLayers.clear();
    state.orders.forEach(o=> refreshOrderLayer(o));
    renderOrdersList(); applyBaseVisibility();
    localStorage.setItem('naryad.json', JSON.stringify(getNaryadsObject()));
  }
  async function saveNaryads(silent=false){
    const content = JSON.stringify(getNaryadsObject(), null, 2);
    if(state.ghNrd){
      let sha = await ghGetSha(state.ghNrd);
      try{
        const res = await ghPut(state.ghNrd, content, sha || undefined);
        if(!silent) alert(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ GitHub: ${res.commit?.sha?.slice(0,7)}`);
        return;
      }catch(e){
        if(e?._status === 409){
          sha = await ghGetSha(state.ghNrd);
          const res = await ghPut(state.ghNrd, content, sha || undefined);
          if(!silent) alert(`–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ (–æ–±–Ω–æ–≤–ª—ë–Ω sha): ${res.commit?.sha?.slice(0,7)}`);
          return;
        }
        throw e;
      }
    }
    // –ª–æ–∫–∞–ª—å–Ω–æ
    const blob = new Blob([content], {type:'application/json;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'naryad.json'; a.click(); URL.revokeObjectURL(a.href);
    if(!silent) alert('–°–∫–∞—á–∞–Ω naryad.json ‚Äî –∑–∞–º–µ–Ω–∏ –µ–≥–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.');
  }

  // –ö–Ω–æ–ø–∫–∏ ¬´–í–∏–¥¬ª
  $('btnShowAll').onclick = ()=>{ state.baseVisibleIds = new Set(state.db.items.map(x=>x.id)); applyBaseVisibility(); renderBaseList(); };
  $('btnHideAll').onclick = ()=>{ state.baseVisibleIds.clear(); applyBaseVisibility(); renderBaseList(); };
  $('btnFit').onclick = ()=> fitAllVisible();

  // –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ (Shift + drag)
  map.getContainer().addEventListener('mousedown',(e)=>{
    if(!state.activeOrderId) return;
    if(!e.shiftKey) return;
    state.dragStart = map.mouseEventToLatLng(e);
    state.dragRect = L.rectangle([state.dragStart, state.dragStart], {color:'#111', weight:1, fillColor:'#111', fillOpacity:0.05}).addTo(map);
    document.body.style.cursor='crosshair';
  });
  map.getContainer().addEventListener('mousemove',(e)=>{
    if(!state.dragRect||!state.dragStart) return;
    const cur = map.mouseEventToLatLng(e);
    state.dragRect.setBounds(L.latLngBounds(state.dragStart, cur));
  });
  map.getContainer().addEventListener('mouseup',()=>{
    if(!state.dragRect) return;
    const b=state.dragRect.getBounds();
    map.removeLayer(state.dragRect); state.dragRect=null; state.dragStart=null; document.body.style.cursor='';
    const order = state.orders.find(x=>x.id===state.activeOrderId); if(!order) return;
    state.db.items.forEach(it=>{
      const layer = ensureBaseLayer(it); if(!layer) return;
      if(b.intersects(layer.getBounds())){
        if(!state.addrToOrder.has(it.id)){
          order.items.push({id:it.id, qty:0}); state.addrToOrder.set(it.id, order.id); state.baseVisibleIds.delete(it.id);
        }
      }
    });
    refreshOrderLayer(order); renderOrdersList(); renderOrderTable(order); applyBaseVisibility(); saveNaryads(true).catch(()=>{});
  });

  // –ó–∞–≥—Ä—É–∑–∫–∞ –±–µ–∑ –∫—ç—à–∞
  function normalizeNaryad(j){ return { version: j.version||1, updated_at: j.updated_at || new Date().toISOString(), orders: Array.isArray(j.orders)? j.orders : [] }; }
  async function loadJsonNoCache(url){
    const bust = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
    const r = await fetch(bust, { cache:'no-store', headers:{'Accept':'application/json'} });
    if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.json();
  }

  // Boot
  (async function boot(){
    // GitHub –ø–∞—Ä–∞–º–µ—Ç—Ä—ã: #ghdb=OWNER/REPO@branch:path/to/database.json&ghnrd=OWNER/REPO@branch:path/to/naryad.json&token=ghp_xxx
    state.ghDb  = parseGhFromHashKey('ghdb',  'database.json');
    state.ghNrd = parseGhFromHashKey('ghnrd', 'naryad.json');
    if(!state.ghNrd && state.ghDb){
      const basePath = state.ghDb.path.split('/'); basePath[basePath.length-1] = 'naryad.json';
      state.ghNrd = { ...state.ghDb, path: basePath.join('/') };
    }

    if(state.ghDb){
      $('loadMsg').textContent = `GitHub: ${state.ghDb.repo}@${state.ghDb.branch} ‚Üí ${state.ghDb.path} | –ù–∞—Ä—è–¥—ã: ${state.ghNrd? state.ghNrd.path : '–ª–æ–∫–∞–ª—å–Ω–æ'}`;
    }else{
      $('loadMsg').textContent = 'Pages: —á–∏—Ç–∞–µ–º ./database.json –∏ ./naryad.json (–µ—Å–ª–∏ –µ—Å—Ç—å).';
    }

    try{
      const dbUrl = state.ghDb ? `https://raw.githubusercontent.com/${state.ghDb.repo}/${state.ghDb.branch}/${state.ghDb.path}` : new URL('database.json', location.href).toString();
      const nrdUrl = state.ghNrd ? `https://raw.githubusercontent.com/${state.ghNrd.repo}/${state.ghNrd.branch}/${state.ghNrd.path}` : new URL('naryad.json', location.href).toString();
      const [db, nrd] = await Promise.all([
        loadJsonNoCache(dbUrl).catch(e=>{ throw new Error('database.json: '+e.message); }),
        loadJsonNoCache(nrdUrl).catch(_=> ({orders: []}))
      ]);
      state.db = normalizeDb(db);
      state.baseVisibleIds = new Set(state.db.items.map(x=>x.id));
      const N = normalizeNaryad(nrd);
      state.orders = N.orders;
      state.addrToOrder.clear();
      state.orders.forEach(o=> o.items.forEach(it=> state.addrToOrder.set(it.id, o.id)) );
      state.orders.forEach(o=> refreshOrderLayer(o));
      renderCityChips(); renderBaseList(); applyBaseVisibility(); renderOrdersList();
      localStorage.setItem('naryad.json', JSON.stringify(getNaryadsObject()));
    }catch(e){
      $('loadMsg').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e.message;
      console.warn(e);
    }
  })();

  async function saveDb(){
    const content = JSON.stringify({ ...state.db, updated_at:new Date().toISOString() }, null, 2);
    if(state.ghDb){
      let sha = await ghGetSha(state.ghDb);
      try{
        const res = await ghPut(state.ghDb, content, sha || undefined);
        return `–ö–æ–º–º–∏—Ç ${res.commit?.sha?.slice(0,7)} –≤ ${state.ghDb.repo}/${state.ghDb.branch}`;
      }catch(e){
        if(e?._status===409){
          sha = await ghGetSha(state.ghDb);
          const res = await ghPut(state.ghDb, content, sha || undefined);
          return `–ö–æ–º–º–∏—Ç ${res.commit?.sha?.slice(0,7)} (sha –æ–±–Ω–æ–≤–ª—ë–Ω)`;
        }
        throw e;
      }
    }
    const blob = new Blob([content], {type:'application/json;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'database.json'; a.click(); URL.revokeObjectURL(a.href);
    throw new Error('–°–∫–∞—á–∞–Ω –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π database.json ‚Äî –∑–∞–º–µ–Ω–∏ –µ–≥–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.');
  }

  // –ü–æ–¥–ø–∏—Å–∏ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏/–∑—É–º–µ
  map.on('moveend zoomend', addBaseLabelsIfZoom);
})(); // –∫–æ–Ω–µ—Ü IIFE
</script>
</body>
</html>
