<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Карта монтажа — простое редактирование базы (Leaflet)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    #app { display: grid; grid-template-columns: 460px 1fr; height:100%; }
    #sidebar { padding:14px; border-right:1px solid #eee; overflow:auto; }
    #map { width:100%; height:100%; }
    .title { font-weight:700; }
    .muted { color:#667085; font-size:13px; }
    .panel { background:#fafafa; border:1px solid #eaeaea; border-radius:12px; padding:12px; margin-bottom:12px; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type="text"] { padding:8px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px; width:100%; }
    button { font-size:14px; padding:8px 10px; border:1px solid #e5e7eb; background:#fff; border-radius:8px; cursor:pointer; }
    button.primary { background:#111827; color:#fff; border-color:#111827; }
    button.ghost { background:#f8fafc; }
    .list { display:flex; flex-direction:column; gap:6px; }
    .item { padding:8px 10px; border:1px dashed #ddd; border-radius:10px; display:grid; grid-template-columns:1fr auto; gap:6px; align-items:center; }
    .item.active { background:#fff6e5; }
    .item .act { display:flex; gap:6px; }
    .hint { font-size:12px; color:#475569; }
    .label { font-size:12px; color:#64748b; }
    .house-label { background:transparent; border:none; transform:translate(-50%,-50%); pointer-events:none; }
    .house-label .hl { display:inline-block; padding:0 3px; font-size:9px; font-weight:700; background:rgba(255,255,255,.96); border:2px solid rgba(0,0,0,.25); border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,.10); line-height:1.1; white-space:nowrap; user-select:none; }
    .danger { color:#b42318; }
    .ok { color:#067647; }
    .toolbar { display:flex; gap:8px; align-items:center; justify-content:space-between; }
    .toolbar .right { display:flex; gap:8px; align-items:center; }
    .badge { font-size:12px; padding:2px 6px; border-radius:999px; background:#f1f5f9; border:1px solid #e5e7eb; }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="panel">
      <div class="toolbar">
        <div class="title">Адреса из базы</div>
        <div class="right">
          <button id="btnConnectFile" class="ghost" title="Подключить файл database.json для прямой записи">Подключить файл</button>
          <span id="countLbl" class="badge"></span>
        </div>
      </div>
      <div class="muted" id="loadMsg" style="margin-top:6px;"></div>
      <div class="list" id="itemsList" style="margin-top:10px;"></div>
    </div>

    <div class="panel" id="editPanel">
      <div class="title" style="margin-bottom:6px;">Редактирование</div>
      <div id="editHint" class="muted">Выбери адрес (кнопка ✏️) в списке выше.</div>
      <div id="editForm" style="display:none;">
        <div class="label">Название (будет видно в UI/нарядах)</div>
        <input id="eTitle" type="text" placeholder="Например: г. Саратов, ул. Рахова, 169/171" />
        <div class="row" style="margin-top:8px;">
          <button id="btnRelink" class="ghost" title="Клик на карте рядом со зданием">Привязать к OSM</button>
          <button id="btnDraw" class="ghost">Нарисовать вручную</button>
          <button id="btnDrawFinish" class="ghost" style="display:none;">Завершить рисование</button>
          <button id="btnDrawUndo" class="ghost" style="display:none;">Отменить точку</button>
          <button id="btnClearPoly" class="ghost">Удалить полигон</button>
        </div>
        <div class="row" style="margin-top:8px;">
          <button id="btnSave" class="primary">Сохранить</button>
          <span id="editMsg" class="muted"></span>
        </div>
        <div class="hint" id="modeHint" style="margin-top:6px;"></div>
      </div>
    </div>

    <div class="panel">
      <div class="title" style="margin-bottom:6px;">Вид</div>
      <div class="row">
        <button id="btnFit" class="ghost">Показать все</button>
      </div>
      <div class="hint" style="margin-top:6px;">Двойной клик по карте выключает рисование.</div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
(function(){
  // === Карта
  const map = L.map('map').setView([51.533, 46.033], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:20, attribution:'&copy; OpenStreetMap contributors' }).addTo(map);

  const $ = (id)=>document.getElementById(id);
  const DEFAULT_COLOR = '#7c3aed';

  // === Состояние
  const state = {
    db: {version:1, updated_at:new Date().toISOString(), items:[]},
    features: new Map(), // id -> polygon layer
    labels: [],
    bounds: L.latLngBounds(),
    selectedId: null,

    // режимы
    relinkMode: false,
    drawMode: false,
    drawPoints: [],
    drawLayer: null,
    previewLayer: null,

    // сохранение
    fileHandle: null // File System Access API
  };

  // === Helpers
  function esc(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  const ringLonLat_to_LatLng = ring => ring.map(([x,y])=>[y,x]);
  const ringLatLng_to_LonLat = ring => ring.map(p=>[p.lng, p.lat]);

  function clearMap(){
    state.features.forEach(l=>map.removeLayer(l));
    state.features.clear();
    state.labels.forEach(m=>map.removeLayer(m));
    state.labels=[];
    state.bounds = L.latLngBounds();
  }

  function placeEdgeLabel(layer, text){
    const b=layer.getBounds();
    const pos = map.layerPointToLatLng(map.latLngToLayerPoint(L.latLng(b.getNorth(), (b.getEast()+b.getWest())/2)).add([0,-12]));
    const icon = L.divIcon({ className:'house-label', html:`<span class="hl">${esc(text||'')}</span>` });
    const mk = L.marker(pos, { icon, interactive:false }).addTo(map);
    state.labels.push(mk);
  }

  function extractHouse(t){
    const s=String(t||'').trim();
    const m=s.match(/,\s*([^,]+)\s*$/); if(m) return m[1].replace(/^(дом|д\.)\s*/i,'').trim();
    const m2=s.match(/(\d+[0-9A-Za-zА-Яа-я\/\-]*?)\s*$/); return m2?m2[1]:s;
  }

  function drawItem(it){
    if(Array.isArray(it.polygon) && it.polygon.length>=3){
      const ll = ringLonLat_to_LatLng(it.polygon);
      const poly = L.polygon(ll, { color:DEFAULT_COLOR, weight:2, fillColor:DEFAULT_COLOR, fillOpacity:.9 }).addTo(map);
      poly.on('click', ()=> focusItem(it.id));
      poly._id = it.id;
      state.features.set(it.id, poly);
      state.bounds.extend(poly.getBounds());
      placeEdgeLabel(poly, extractHouse(it.title));
    }
  }

  function renderAll(){
    clearMap();
    state.db.items.forEach(drawItem);
    if(state.bounds.isValid()) map.fitBounds(state.bounds.pad(0.15));
    renderList();
  }

  // === Список
  function renderList(){
    const host = $('itemsList'); host.innerHTML='';
    $('countLbl').textContent = state.db.items.length;
    state.db.items.forEach(it=>{
      const div = document.createElement('div');
      div.className = 'item' + (state.selectedId===it.id?' active':'');
      div.innerHTML = `
        <div class="title">${esc(it.title||'(без названия)')}</div>
        <div class="act">
          <button class="ghost" title="Показать на карте">Показать</button>
          <button class="ghost" title="Редактировать">✏️</button>
        </div>
        <div class="muted" style="grid-column:1 / -1">${it.polygon?'Контур есть':'Контур не задан'}</div>
      `;
      const [btnShow, btnEdit] = div.querySelectorAll('button');
      btnShow.onclick = ()=> focusItem(it.id);
      btnEdit.onclick = ()=> openEditor(it.id);
      host.appendChild(div);
    });
    // панель
    const hasSel = !!state.selectedId;
    $('editForm').style.display = hasSel ? '' : 'none';
    $('editHint').style.display = hasSel ? 'none' : '';
  }

  function focusItem(id){
    state.selectedId = id;
    const layer = state.features.get(id);
    renderList();
    if(layer) map.fitBounds(layer.getBounds().pad(0.3));
  }

  // === Редактор
  function currentItem(){ return state.db.items.find(x=>x.id===state.selectedId) || null; }

  function openEditor(id){
    state.selectedId = id;
    const it = currentItem();
    $('eTitle').value = it?.title || '';
    $('editMsg').textContent = '';
    $('modeHint').textContent = '';
    stopRelinkMode(); stopDrawMode(true);
    renderList();
  }

  // Привязка к OSM
  function startRelinkMode(){
    if(!state.selectedId){ alert('Сначала выбери адрес.'); return; }
    stopDrawMode(true);
    state.relinkMode = true;
    $('modeHint').textContent = 'Режим привязки: кликни по карте рядом со зданием (Overpass).';
  }
  function stopRelinkMode(){
    state.relinkMode = false;
    if(state.previewLayer){ map.removeLayer(state.previewLayer); state.previewLayer=null; }
  }

  // Рисование вручную
  function startDrawMode(){
    if(!state.selectedId){ alert('Сначала выбери адрес.'); return; }
    stopRelinkMode();
    state.drawMode = true; state.drawPoints=[]; if(state.drawLayer){ map.removeLayer(state.drawLayer); state.drawLayer=null; }
    $('btnDrawFinish').style.display=''; $('btnDrawUndo').style.display='';
    $('modeHint').textContent = 'Режим рисования: кликай по карте, чтобы ставить точки. «Завершить рисование» — когда контур готов.';
  }
  function stopDrawMode(clear=false){
    state.drawMode = false;
    $('btnDrawFinish').style.display='none'; $('btnDrawUndo').style.display='none';
    if(clear){ state.drawPoints=[]; if(state.drawLayer){ map.removeLayer(state.drawLayer); state.drawLayer=null; } }
  }
  function updateDrawLayer(){
    if(state.drawLayer){ map.removeLayer(state.drawLayer); state.drawLayer=null; }
    if(state.drawPoints.length){
      const pts = state.drawPoints.slice();
      if(pts.length>=3) pts.push(pts[0]); // замкнуть
      state.drawLayer = L.polyline(pts, { color:'#111', weight:2 }).addTo(map);
    }
  }

  $('btnRelink').onclick = startRelinkMode;
  $('btnDraw').onclick = startDrawMode;
  $('btnDrawFinish').onclick = ()=>{
    if(state.drawPoints.length<3){ alert('Нужно минимум 3 точки.'); return; }
    // превратить в полигон-превью
    if(state.previewLayer){ map.removeLayer(state.previewLayer); state.previewLayer=null; }
    state.previewLayer = L.polygon(state.drawPoints, { color:'#111', weight:2, fillColor:DEFAULT_COLOR, fillOpacity:.5 }).addTo(map);
    stopDrawMode(false);
    $('modeHint').textContent = 'Контур нарисован. Нажми «Сохранить».';
  };
  $('btnDrawUndo').onclick = ()=>{
    state.drawPoints.pop(); updateDrawLayer();
  };
  $('btnClearPoly').onclick = ()=>{
    const it=currentItem(); if(!it) return;
    it.polygon = null; state.db.updated_at = new Date().toISOString();
    renderAll(); $('editMsg').textContent='Полигон удалён (локально).';
  };

  // Клик по карте — логика режимов
  map.on('click', async (e)=>{
    if(state.drawMode){
      state.drawPoints.push(e.latlng);
      updateDrawLayer();
      return;
    }
    if(state.relinkMode){
      $('modeHint').textContent = 'Ищу ближайший контур…';
      const ring = await fetchOverpassPolygon({ lon:e.latlng.lng, lat:e.latlng.lat }, 500);
      if(!ring){ $('modeHint').textContent = 'Не нашёл контур. Кликни ближе и повтори.'; return; }
      if(state.previewLayer){ map.removeLayer(state.previewLayer); state.previewLayer=null; }
      state.previewLayer = L.polygon(ringLonLat_to_LatLng(ring), { color:'#111', weight:2, fillColor:DEFAULT_COLOR, fillOpacity:.5 }).addTo(map);
      map.fitBounds(state.previewLayer.getBounds().pad(0.2));
      $('modeHint').textContent = 'Контур найден. Нажми «Сохранить».';
    }
  });
  map.on('dblclick', ()=>{ if(state.drawMode){ stopDrawMode(true); $('modeHint').textContent='Рисование отменено.'; } });

  // Сохранить
  $('btnSave').onclick = async ()=>{
    const it=currentItem(); if(!it) return;
    it.title = $('eTitle').value.trim();
    // если есть превью контура — берём его
    if(state.previewLayer){
      const ring = state.previewLayer.getLatLngs()[0]; // внешний контур
      it.polygon = ringLatLng_to_LonLat(ring);
    }
    state.db.updated_at = new Date().toISOString();

    // перерисовать и сохранить
    renderAll();
    stopRelinkMode(); stopDrawMode(true); if(state.previewLayer){ map.removeLayer(state.previewLayer); state.previewLayer=null; }
    try{
      await saveDb(); $('editMsg').textContent='Сохранено в database.json.'; $('editMsg').className='muted ok';
    }catch(err){
      $('editMsg').textContent='Сохранено локально. Не удалось записать в файл: ' + err.message; $('editMsg').className='muted danger';
    }
  };

  // === Overpass helper
  async function fetchOverpassPolygon({ lon, lat }, radius = 500){
    const EPS=['https://overpass.kumi.systems/api/interpreter','https://overpass-api.de/api/interpreter','https://overpass.openstreetmap.ru/api/interpreter'];
    const q=`[out:json][timeout:60];(way["building"](around:${radius},${lat},${lon});relation["building"](around:${radius},${lat},${lon}););out body geom;`;
    for(const ep of EPS){
      try{
        const r=await fetch(ep,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},body:new URLSearchParams({data:q})});
        if(!r.ok) continue; const j=await r.json(); const a=j.elements||[]; if(!a.length) continue;
        let best=null, bestD=Infinity;
        for(const el of a){
          const g=el.geometry; if(!Array.isArray(g)||g.length<4) continue;
          const ring=g.map(p=>[p.lon,p.lat]);
          let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
          ring.forEach(([x,y])=>{ if(x<minX)minX=x; if(x>maxX)maxX=x; if(y<minY)minY=y; if(y>maxY)maxY=y; });
          const cx=(minX+maxX)/2, cy=(minY+maxY)/2;
          const d=(cx-lon)*(cx-lon)+(cy-lat)*(cy-lat);
          if(d<bestD){bestD=d;best=ring;}
        }
        if(best){
          const f=best[0], l=best[best.length-1];
          if(f[0]!==l[0]||f[1]!==l[1]) best.push([f[0],f[1]]);
          return best;
        }
      }catch(e){ /* try next */ }
    }
    return null;
  }

  // === Загрузка базы
  function normalizeDb(j){
    return {
      version: j.version||1,
      updated_at: j.updated_at || new Date().toISOString(),
      items: Array.isArray(j.items) ? j.items.map(x=>({
        id: String(x.id || (crypto?.randomUUID?.() || Date.now()+Math.random())),
        title: x.title || '',
        polygon: Array.isArray(x.polygon) ? x.polygon : null
      })) : []
    };
  }

  async function loadDbFromUrl(url){
    const r = await fetch(url, { headers:{'Accept':'application/json'}});
    if(!r.ok) throw new Error('HTTP '+r.status);
    state.db = normalizeDb(await r.json());
    renderAll();
  }

  (async function boot(){
    const param = new URLSearchParams(location.search).get('data');
    try{
      if(param){ await loadDbFromUrl(param); $('loadMsg').textContent='Загружено из параметра ?data.'; }
      else { await loadDbFromUrl('database.json'); $('loadMsg').textContent='Загружено: ./database.json'; }
    }catch(e){
      $('loadMsg').textContent='База не найдена. Подключи файл или размести database.json рядом с index.html.'; console.warn(e);
    }
  })();

  $('btnFit').onclick = ()=>{ if(state.bounds.isValid()) map.fitBounds(state.bounds.pad(0.15)); };

  // === Сохранение в файл (File System Access API) + fallback «скачать»
  $('btnConnectFile').onclick = async ()=>{
    if(!window.showOpenFilePicker){ alert('Браузер не поддерживает прямую запись в файл. При сохранении будет скачан JSON.'); return; }
    try{
      const [handle] = await window.showOpenFilePicker({
        multiple: false,
        types: [{ description:'JSON', accept:{'application/json':['.json']} }],
        excludeAcceptAllOption: true
      });
      const file = await handle.getFile();
      if(!/\.json$/i.test(file.name)) { alert('Нужен JSON-файл.'); return; }
      state.fileHandle = handle;
      $('loadMsg').textContent = 'Файл подключен: ' + file.name;
    }catch(e){ /* cancel */ }
  };

  async function saveDb(){
    const content = JSON.stringify({...state.db, updated_at:new Date().toISOString()}, null, 2);
    if(state.fileHandle && state.fileHandle.createWritable){
      const w = await state.fileHandle.createWritable();
      await w.write(content);
      await w.close();
      return;
    }
    // fallback — скачать
    const blob = new Blob([content], {type:'application/json;charset=utf-8'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'database.json';
    a.click(); URL.revokeObjectURL(a.href);
    throw new Error('нет доступа к файлу — скачан обновлённый JSON');
  }

  // перестройка подписей при движении карты
  map.on('moveend zoomend', ()=>{
    state.labels.forEach(m=>map.removeLayer(m)); state.labels=[];
    state.db.items.forEach(it=>{
      const l = state.features.get(it.id);
      if(l) placeEdgeLabel(l, extractHouse(it.title));
    });
  });

})();
</script>
</body>
</html>
