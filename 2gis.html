<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Карта монтажа — подсветка домов (2ГИС)</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    #app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
    #sidebar { padding: 14px; border-right: 1px solid #eee; overflow: auto; }
    #map { width: 100%; height: 100%; }
    .panel { background: #fafafa; border: 1px solid #eaeaea; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row input, .row button, textarea { font-size: 14px; }
    textarea { width: 100%; min-height: 120px; resize: vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; }
    .legend { display: grid; grid-template-columns: 1fr auto; gap: 6px 10px; font-size: 13px; }
    .swatch { width: 18px; height: 18px; border-radius: 4px; border: 1px solid rgba(0,0,0,.15); }
    .item { padding: 8px 10px; border-radius: 10px; border: 1px dashed #ddd; margin-bottom: 6px; cursor: pointer; }
    .muted { color: #666; font-size: 13px; }
    .link { color: #0b7de3; text-decoration: none; }
    .status { padding: 2px 6px; border-radius: 999px; font-size: 12px; border: 1px solid rgba(0,0,0,.12); }
    .pill { padding: 2px 6px; border-radius: 999px; font-size: 12px; background: #f1f5f9; }
    .small { font-size: 12px; }
  </style>
  <!-- 2GIS MapGL -->
  <script src="https://mapgl.2gis.com/api/js/v1"></script>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="panel">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
        <div>
          <div style="font-weight:700;">Карта монтажа — подсветка домов</div>
          <div class="muted">Вставь адреса → «Построить». Понимает и твой 6-колоночный формат.</div>
        </div>
        <a class="link small" href="#" id="btnFit">Показать все</a>
      </div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">1) Ключ API 2ГИС</div>
      <input id="apiKey" type="password" placeholder="Вставьте ключ 2ГИС" style="width:100%; padding:8px; border-radius:8px; border:1px solid #ddd;" />
      <div class="muted small" style="margin-top:6px;">Нужны права: <b>MapGL</b> и <b>Catalog API</b>. Если ниже оставишь поле пустым — возьмётся KEY из кода.</div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">2) Адреса для монтажа</div>
      <textarea id="addrInput" placeholder="Форматы ввода:
• Адрес[TAB]Статус[TAB]#Цвет
• ID  ID2  Город  Улица  Дом  Подъезд  (через табы/пробелы). Статус автогенерируется как 'Подъезд N'."></textarea>
      <div class="row" style="margin-top:8px;">
        <button id="btnBuild">Построить</button>
        <button id="btnClear">Очистить</button>
      </div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Легенда статусов</div>
      <div id="legend" class="legend"></div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Найденные точки</div>
      <div id="list"></div>
    </div>
  </div>
  <div id="map"></div>
</div>

<script>
(function(){
  // ВСТАВЬ СВОЙ ДЕМО-КЛЮЧ 2ГИС (или оставь пустым и вводи в поле слева)
  const KEY = 'b071d8db-8fa6-4a9f-927e-85145f520db9';

  // ----------------------------
  // UI helpers
  // ----------------------------
  const $ = (sel) => document.querySelector(sel);

  const state = {
    map: null,
    overlays: [],
    statusColor: new Map(), // status -> color
    bounds: { minLon: +Infinity, minLat: +Infinity, maxLon: -Infinity, maxLat: -Infinity },
  };

  function updateBounds([lon,lat]){
    const b = state.bounds;
    b.minLon = Math.min(b.minLon, lon);
    b.minLat = Math.min(b.minLat, lat);
    b.maxLon = Math.max(b.maxLon, lon);
    b.maxLat = Math.max(b.maxLat, lat);
  }

  function fitToAll(){
    const { minLon, minLat, maxLon, maxLat } = state.bounds;
    if (!isFinite(minLon) || !isFinite(minLat) || !isFinite(maxLon) || !isFinite(maxLat)) return;
    const center = [ (minLon + maxLon)/2, (minLat + maxLat)/2 ];
    state.map.setCenter(center);
    const dx = Math.abs(maxLon - minLon);
    const dy = Math.abs(maxLat - minLat);
    const span = Math.max(dx, dy);
    let zoom = 14;
    if (span > 0.5) zoom = 10; else if (span > 0.2) zoom = 11; else if (span > 0.1) zoom = 12; else if (span > 0.05) zoom = 13; else if (span > 0.02) zoom = 14; else if (span > 0.01) zoom = 15; else zoom = 16;
    state.map.setZoom(zoom);
  }

  // ----------------------------
  // Map init
  // ----------------------------
  function ensureMap(){
    if (state.map) return;
    // начальный центр — Саратов
    state.map = new mapgl.Map('map', {
      center: [46.033, 51.533],
      zoom: 12,
      key: KEY || 'TEMP-KEY', // если поле пустое — используем зашитый KEY
    });
  }

  function clearOverlays(){
    state.overlays.forEach(o=>{ try { o.destroy && o.destroy(); } catch(e){} });
    state.overlays = [];
    state.bounds = { minLon: +Infinity, minLat: +Infinity, maxLon: -Infinity, maxLat: -Infinity };
    $('#list').innerHTML = '';
  }

  function addLegendEntry(status, color){
    const row = document.createElement('div');
    row.style.display = 'contents'; // grid cells
    const title = document.createElement('div');
    title.textContent = status || '(без статуса)';
    const sw = document.createElement('div');
    sw.className = 'swatch';
    sw.style.background = color || '#7c3aed';
    $('#legend').appendChild(title);
    $('#legend').appendChild(sw);
  }

  function rebuildLegend(){
    const host = $('#legend');
    host.innerHTML = '';
    const entries = Array.from(state.statusColor.entries());
    if (!entries.length){ addLegendEntry('Адреса', '#7c3aed'); return; }
    entries.forEach(([s,c])=> addLegendEntry(s, c));
  }

  // ----------------------------
  // Drawing helpers (Polygon/Marker)
  // ----------------------------
  function drawPolygon(coords, opts){
    const polygon = new mapgl.Polygon(state.map, {
      coordinates: [coords], // внешний контур
      strokeWidth: 2,
      strokeColor: opts.strokeColor || '#000000',
      color: opts.fill || '#00000033',
    });
    state.overlays.push(polygon);
    return polygon;
  }

  function drawMarker(point, html){
    const m = new mapgl.HtmlMarker(state.map, {
      coordinates: point,
      html: html || '<div style="width:10px;height:10px;border-radius:50%;background:#111"></div>'
    });
    state.overlays.push(m);
    return m;
  }

  function addListItem(item){
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
        <div style="font-weight:600">${escapeHtml(item.address)}</div>
        ${item.status ? `<span class="pill" style="border:1px solid ${item.color||'#ddd'}">${escapeHtml(item.status)}</span>` : ''}
      </div>
      <div class="muted small">${item.lat && item.lon ? `${item.lat.toFixed(6)}, ${item.lon.toFixed(6)}` : '—'}</div>
    `;
    el.addEventListener('click', ()=>{
      if (item.lon && item.lat){ state.map.setCenter([item.lon, item.lat]); state.map.setZoom(17); }
    });
    $('#list').appendChild(el);
  }

  function escapeHtml(s){
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  }

  // ----------------------------
  // Geocoding via 2GIS Catalog API
  // ----------------------------
  async function geocodeAddress(key, q){
    const url = new URL('https://catalog.api.2gis.com/3.0/items/geocode');
    url.searchParams.set('q', q);
    url.searchParams.set('fields', 'items.point,items.geometry');
    url.searchParams.set('key', key);
    const r = await fetch(url.toString());
    if (!r.ok) throw new Error('Catalog API error: ' + r.status);
    const j = await r.json();
    const item = j?.result?.items?.[0];
    if (!item) return null;
    const point = item.point ? [item.point.lon, item.point.lat] : null;
    // Попробуем вытащить контур здания (формат у 2ГИС может отличаться)
    let polygonCoords = null;
    const g = item.geometry;
    if (g && g.selection && Array.isArray(g.selection.contours)){
      const c = g.selection.contours[0].points;
      if (Array.isArray(c) && c.length){
        polygonCoords = c.map(p => [p[0] ?? p.lon ?? p.x, p[1] ?? p.lat ?? p.y]);
      }
    } else if (g && g.coordinates) {
      const arr = g.coordinates?.[0];
      if (Array.isArray(arr) && arr.length){
        polygonCoords = arr.map(pt => [pt[0], pt[1]]);
      }
    }
    return { point, polygonCoords };
  }

  // ----------------------------
  // Parse input (адреса/таблица)
  // ----------------------------
  function parseAddresses(text){
    const lines = text.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    const out = [];
    for (const line of lines){
      // 6-колоночный формат: ID ID2 City Street House Entrance
      const m6 = /^(\S+)\s+(\S+)\s+(\S+)\s+(.+?)\s+(\S+)\s+(\S+)$/.exec(line);
      if (m6) {
        const city = m6[3], street = m6[4], house = m6[5], entr = m6[6];
        out.push({ address: `${city}, ${street} ${house}`, status: `Подъезд ${entr}`, color: '' });
        continue;
      }
      // Формат с табами: Адрес \t Статус \t Цвет
      const parts = line.split(/\t/);
      if (parts.length >= 1) {
        const address = parts[0]?.trim();
        const status  = parts[1]?.trim() || '';
        const color   = (parts[2]?.trim() || '').toLowerCase();
        out.push({ address, status, color });
        continue;
      }
    }
    return out;
  }

  function ensureColorForStatus(item){
    if (item.color) return item.color;
    if (!item.status) return '#7c3aed';
    if (state.statusColor.has(item.status)) return state.statusColor.get(item.status);
    const h = Math.abs(hash(item.status)) % 360;
    const c = `hsl(${h} 90% 70%)`;
    state.statusColor.set(item.status, c);
    return c;
  }
  function hash(str){ let h=0; for (let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return h; }

  // ----------------------------
  // Main build
  // ----------------------------
  async function build(){
    const key = ($('#apiKey').value.trim() || KEY);
    if (!key){ alert('Вставьте ключ API 2ГИС'); return; }

    clearOverlays();

    const items = parseAddresses($('#addrInput').value);
    for (const item of items){
      const color = ensureColorForStatus(item);
      try {
        const res = await geocodeAddress(key, item.address);
        if (!res){ addListItem(item); continue; }
        if (res.polygonCoords){
          // Контур здания
          drawPolygon(res.polygonCoords, { fill: color + '55', strokeColor: color });
          const centroid = res.polygonCoords.reduce((acc, p)=>[acc[0]+p[0], acc[1]+p[1]],[0,0]).map(v=>v/res.polygonCoords.length);
          item.lon = centroid[0]; item.lat = centroid[1];
          updateBounds(centroid);
          drawMarker(centroid, `<div style="width:12px;height:12px;border-radius:999px;border:2px solid #fff;background:${color};box-shadow:0 0 0 2px ${color}55"></div>`);
        } else if (res.point){
          // Нет контура — ставим маркер
          item.lon = res.point[0]; item.lat = res.point[1];
          updateBounds(res.point);
          drawMarker(res.point, `<div style="width:14px;height:14px;border-radius:999px;border:2px solid #fff;background:${color};box-shadow:0 0 0 2px ${color}55"></div>`);
        }
        addListItem(item);
        await new Promise(r=>setTimeout(r, 120)); // не упираться в лимиты
      } catch (e){
        console.warn('Ошибка геокодинга', item.address, e);
        addListItem(item);
      }
    }
    rebuildLegend();
    fitToAll();
  }

  // ----------------------------
  // Wire UI
  // ----------------------------
  ensureMap();
  if (KEY) { document.getElementById('apiKey').value = KEY; }
  document.getElementById('btnBuild').addEventListener('click', build);
  document.getElementById('btnClear').addEventListener('click', ()=>{
    document.getElementById('addrInput').value='';
    clearOverlays(); rebuildLegend();
  });
  document.getElementById('btnFit').addEventListener('click', fitToAll);

  // демо (твой формат, табы)
  document.getElementById('addrInput').value = [
    '12\t970\tСаратов\t1-я Беговая\t13\t4',
    '20\t772\tСаратов\t1-й Кавказский\t10\t4'
  ].join('\n');
})();
</script>
</body>
</html>
