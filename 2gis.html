<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Карта монтажа — тест без ключей (OSM)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    #app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
    #sidebar { padding: 14px; border-right: 1px solid #eee; overflow: auto; }
    #map { width: 100%; height: 100%; }
    .panel { background: #fafafa; border: 1px solid #eaeaea; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .row { display: flex; gap: 8px; align-items: center; }
    textarea { width: 100%; min-height: 120px; resize: vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; font-size: 13px; }
    .legend { display: grid; grid-template-columns: 1fr auto; gap: 6px 10px; font-size: 13px; }
    .swatch { width: 18px; height: 18px; border-radius: 4px; border: 1px solid rgba(0,0,0,.15); }
    .item { padding: 8px 10px; border-radius: 10px; border: 1px dashed #ddd; margin-bottom: 6px; cursor: pointer; }
    .muted { color: #666; font-size: 13px; }
    .pill { padding: 2px 6px; border-radius: 999px; font-size: 12px; background: #f1f5f9; border: 1px solid #e5e7eb; }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="panel">
      <div style="font-weight:700;">Карта монтажа — OSM тест (без ключей)</div>
      <div class="muted">Пока ждём доступ к 2ГИС, можно тестировать here. Источник: OpenStreetMap/Nominatim.</div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Адреса</div>
      <textarea id="addrInput" placeholder="Поддерживаются форматы:\n1) Адрес\tСтатус\t#Цвет\n2) ID ID2 Город Улица Дом Подъезд (через табы/пробелы). Статус задаётся как 'Подъезд N'."></textarea>
      <div class="row" style="margin-top:8px;">
        <button id="btnBuild">Построить</button>
        <button id="btnClear">Очистить</button>
        <button id="btnFit">Показать все</button>
      </div>
      <div class="muted" style="margin-top:6px;">Важно: Nominatim ограничивает частоту запросов. Используйте для небольших списков (тест).</div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Легенда статусов</div>
      <div id="legend" class="legend"></div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Найденные точки</div>
      <div id="list"></div>
    </div>
  </div>

  <div id="map"></div>
</div>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const state = { map:null, layers:[], statusColor:new Map(), bounds:null };

  function ensureMap(){
    if(state.map) return;
    state.map = L.map('map').setView([51.533, 46.033], 12); // Саратов
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(state.map);
  }

  function clearMap(){
    state.layers.forEach(l=>{ try{ state.map.removeLayer(l);}catch(e){} });
    state.layers = [];
    state.bounds = null;
    $('#list').innerHTML = '';
  }

  function extendBounds(layer){
    const b = layer.getBounds ? layer.getBounds() : (layer.getLatLng ? L.latLngBounds([layer.getLatLng()]) : null);
    if(!b) return;
    if(!state.bounds) state.bounds = b; else state.bounds.extend(b);
  }

  function fitAll(){ if(state.bounds) state.map.fitBounds(state.bounds.pad(0.2)); }

  function ensureColor(status, color){
    if(color) return color;
    if(!status) return '#7c3aed';
    if(state.statusColor.has(status)) return state.statusColor.get(status);
    const h = Math.abs(hash(status)) % 360; const c = `hsl(${h} 85% 62%)`;
    state.statusColor.set(status, c); return c;
  }
  function hash(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0;} return h; }

  function addListItem(item){
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
      <div style="font-weight:600">${escapeHtml(item.address)}</div>
      ${item.status?`<span class='pill'>${escapeHtml(item.status)}</span>`:''}
    </div>
    <div class='muted'>${item.lat && item.lon ? `${item.lat.toFixed(6)}, ${item.lon.toFixed(6)}` : '—'}</div>`;
    el.addEventListener('click', ()=>{ if(item.lat&&item.lon){ state.map.setView([item.lat,item.lon], 17); }});
    $('#list').appendChild(el);
  }

  function rebuildLegend(){
    const host=$('#legend'); host.innerHTML='';
    const entries = Array.from(state.statusColor.entries());
    if(!entries.length){ addLegend('Адреса', '#7c3aed'); return; }
    entries.forEach(([s,c])=>addLegend(s,c));
  }
  function addLegend(s,c){
    const t=document.createElement('div'); t.textContent=s; const sw=document.createElement('div'); sw.className='swatch'; sw.style.background=c; const host=$('#legend'); host.appendChild(t); host.appendChild(sw);
  }

  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  // --- Вспомогательные парсеры ввода ---
  function parseInput(text){
    const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const out = [];
    const sixCols = /^(\S+)\s+(\S+)\s+(\S+)\s+(.+?)\s+(\S+)\s+(\S+)$/u; // ID ID2 City Street House Entrance
    for(const line of lines){
      const m = sixCols.exec(line);
      if(m){
        const city=m[3], street=m[4], house=m[5], entr=m[6];
        out.push({ address:`${city}, ${street} ${house}`, status:`Подъезд ${entr}`, color:'' });
        continue;
      }
      const tab = line.split(/\t/);
      if(tab.length>=1){
        out.push({ address:tab[0]?.trim(), status:tab[1]?.trim()||'', color:(tab[2]?.trim()||'').toLowerCase() });
      }
    }
    return out;
  }

  // --- Геокодер на Nominatim (OSM). Возвращает polygon, если есть ---
  async function geocodeOSM(q){
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('q', q);
    url.searchParams.set('format', 'json');
    url.searchParams.set('polygon_geojson', '1');
    url.searchParams.set('addressdetails', '1');
    url.searchParams.set('limit', '1');
    url.searchParams.set('accept-language', 'ru');
    const r = await fetch(url.toString(), { headers: { 'Accept': 'application/json' }});
    if(!r.ok) throw new Error('Nominatim error '+r.status);
    const arr = await r.json();
    const it = arr[0];
    if(!it) return null;
    const point = [parseFloat(it.lon), parseFloat(it.lat)];
    const gj = it.geojson;
    return { point, gj };
  }

  async function build(){
    ensureMap();
    clearMap();
    const items = parseInput($('#addrInput').value);
    for(const item of items){
      const color = ensureColor(item.status, item.color);
      try{
        const res = await geocodeOSM(item.address);
        if(!res){ addListItem(item); continue; }
        const [lon,lat] = res.point; item.lon=lon; item.lat=lat; addListItem(item);
        if(res.gj && (res.gj.type==='Polygon' || res.gj.type==='MultiPolygon')){
          const lyr = L.geoJSON(res.gj, { style:{ color: color, weight:2, fillColor: color, fillOpacity:0.35 }}).addTo(state.map);
          state.layers.push(lyr);
          extendBounds(lyr);
        } else {
          const m = L.circleMarker([lat,lon], { radius:6, weight:2, color:'#fff', fillColor: color, fillOpacity:1, pane:'markerPane' }).addTo(state.map);
          state.layers.push(m);
          extendBounds(m);
        }
        await delay(150);
      }catch(e){ console.warn('Ошибка геокодинга', item.address, e); addListItem(item); }
    }
    rebuildLegend(); fitAll();
  }

  const delay = (ms)=>new Promise(r=>setTimeout(r,ms));

  // UI
  ensureMap();
  document.getElementById('btnBuild').addEventListener('click', build);
  document.getElementById('btnClear').addEventListener('click', ()=>{ $('#addrInput').value=''; clearMap(); rebuildLegend(); });
  document.getElementById('btnFit').addEventListener('click', fitAll);

  // демо
  document.getElementById('addrInput').value = [
    '12\t970\tСаратов\t1-я Беговая\t13\t4',
    '20\t772\tСаратов\t1-й Кавказский\t10\t4'
  ].join('\n');
})();
</script>
</body>
</html>
